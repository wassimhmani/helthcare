<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title.agenda">Secretary Agenda</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="library/tailwind.js"></script>
    
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            if (window.I18n && I18n.initI18n) {
                console.log('Initializing i18n system...');
                I18n.initI18n().then(() => {
                    console.log('i18n system initialized');
                    // Force translation after initialization
                    setTimeout(() => {
                        if (window.I18n && window.I18n.walkAndTranslate) {
                            window.I18n.walkAndTranslate();
                            console.log('Translations applied');
                        }
                    }, 100);
                }).catch(error => {
                    console.error('Error initializing i18n:', error);
                });
            } else {
                console.error('i18n system not available');
            }
        });
    </script>
    <script src="scripts/tailwinconfig.js"></script>
   
    <link rel="stylesheet" href="styles/agenda_style.css">
</head>

<body class="min-h-screen bg-gray-50">
    <!-- Firm Banner (visible on screen and prints on reports) -->
    <div class="firm-banner" role="banner">
        <div class="firm-banner-inner">
            <!-- Logo removed per user request -->
            <div class="firm-text">
                <div class="firm-name" id="firmName"></div>
                <div class="firm-tagline" id="firmAddress"></div>
                <div class="firm-meta" id="firmPhone"></div>
            </div>
        </div>
    </div>
    <script>
        function updateCabinetInfo() {
            try {
                var stored = localStorage.getItem('cabinet_settings');
                var settings = stored ? JSON.parse(stored) : {};
                var name = settings.name && settings.name.trim() ? settings.name : 'Medical Center';
                var address = settings.address && settings.address.trim() ? settings.address : 'Tunis, Tunisia';
                var phone = settings.phone && settings.phone.trim() ? settings.phone : '00 000 000';
                var logo = settings.logo || '';

                var nameEl = document.getElementById('firmName');
                var addrEl = document.getElementById('firmAddress');
                var phoneEl = document.getElementById('firmPhone');

                if (nameEl) nameEl.textContent = name;
                if (addrEl) addrEl.textContent = address;
                if (phoneEl) phoneEl.textContent = 'Tel: ' + phone;

                // Update navigation logo
                var navLogoEl = document.getElementById('navLogo');
                if (navLogoEl) {
                    if (logo && /^data:image\//.test(logo)) {
                        var img = document.createElement('img');
                        img.src = logo;
                        img.alt = name || 'Logo';
                        img.style.maxHeight = '80px';
                        img.style.width = 'auto';
                        img.style.objectFit = 'contain';
                        navLogoEl.innerHTML = '';
                        navLogoEl.appendChild(img);
                        console.log('Logo loaded successfully');
                    } else {
                        // Keep fallback text if no logo
                        navLogoEl.innerHTML = '<span class="nav-logo-fallback">' + (name || 'Healthcare System') + '</span>';
                        console.log('No logo found, using fallback text');
                    }
                }
            } catch (e) {
                console.error('Error updating cabinet info:', e);
            }
        }

        // Run immediately and also after page loads
        updateCabinetInfo();
        document.addEventListener('DOMContentLoaded', updateCabinetInfo);
        
        // Make function globally available for updates
        window.updateCabinetInfo = updateCabinetInfo;
        
        // Global function to force translation updates
        window.forceTranslationUpdate = function() {
            if (window.I18n && window.I18n.walkAndTranslate) {
                window.I18n.walkAndTranslate();
                console.log('Forced translation update');
            }
        };
    </script>
    <!-- Horizontal Navigation Menu -->
    <nav class="nav-menu">
        <div class="nav-container">
            <div class="nav-wrapper">
                <!-- Logo/Brand -->
                <div class="nav-logo" id="navLogo">
                    <span class="nav-logo-fallback">Healthcare System</span>
                </div>

                <!-- Desktop Menu -->
                <div class="nav-links">
                    <a href="#" class="nav-link active" data-translate="dashboard">Dashboard</a>
                    <a href="#" class="nav-link" id="nav-patients" onclick="showPatientManagement(true)"
                        data-translate="patients" data-permission="view_patients">Patients</a>
                    <a href="#" id="doctorDashboardLink" class="nav-link" style="display:none"
                        onclick="showDoctorDashboard()" data-translate="consultation" data-permission="view_consultations">Consultation</a>
                    <a href="#" class="nav-link" id="nav-billing" onclick="showBillingOrReadyBills()" 
                        data-translate="billing" data-permission="view_bills">Billing</a>
                    <a href="#" class="nav-link" id="nav-expenses" onclick="showExpensesModal(); return false;" 
                        data-translate="expenses" data-permission="view_expenses">Expenses</a>
                    <a href="#" class="nav-link" id="nav-reports" onclick="showReportsModal()" 
                        data-translate="reports" data-permission="view_reports">Reports</a>
                    <a href="#" class="nav-link" id="nav-settings" onclick="showSettingsMenu()" 
                        data-translate="settings" data-permission="access_settings">Settings</a>
                </div>
                <!-- User Profile -->
                <div class="user-profile">
                    <div class="user-avatar">JD</div>
                    <div class="user-info">
                        <p class="user-name">John Doe</p>
                        <p class="user-role">Secretary</p>
                    </div>
                    <button class="logout-btn" onclick="logout()" title="Logout">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span data-translate="logout">Logout</span>
                    </button>
                </div>

                <!-- Mobile menu button -->
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile menu -->
        <div class="mobile-menu" id="mobile-menu">
            <div class="mobile-nav-links">
                <a href="#" class="mobile-nav-link active" data-translate="dashboard">Dashboard</a>
                <a href="#" class="mobile-nav-link" id="nav-patients-mobile" onclick="showPatientManagement(true)"
                    data-translate="patients" data-permission="view_patients">Patients</a>
                <a href="#" id="doctorDashboardLinkMobile" class="mobile-nav-link" style="display:none"
                    onclick="showDoctorDashboard()" data-translate="consultation" data-permission="view_consultations">Consultation</a>
                <a href="#" class="mobile-nav-link" id="nav-billing-mobile" onclick="showBillingOrReadyBills()" 
                    data-translate="billing" data-permission="view_bills">Billing</a>
                <a href="#" class="mobile-nav-link" id="nav-expenses-mobile" onclick="showExpensesModal(); return false;" 
                    data-translate="expenses" data-permission="view_expenses">Expenses</a>
                <a href="#" class="mobile-nav-link" id="nav-reports-mobile" onclick="showReportsModal()" 
                    data-translate="reports" data-permission="view_reports">Reports</a>
                <a href="#" class="mobile-nav-link" id="nav-settings-mobile" onclick="showSettingsMenu()"
                    data-translate="settings" data-permission="access_settings">Settings</a>
                <a href="#" class="mobile-nav-link logout-mobile" onclick="logout()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        style="margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Add Appointment Modal -->
    <div class="modal" id="addAppointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="add_new_appointment">Add New Appointment</h2>
                <button class="modal-close" onclick="closeAddAppointmentModal()">&times;</button>
            </div>

            <form id="appointmentForm">
                <div class="form-group">
                    <label class="form-label" for="patientSelection" data-translate="select_patient">Select Patient
                        *</label>
                    <select id="patientSelection" class="form-input" required onchange="handlePatientSelection()">
                        <option value="" data-translate="choose_patient">Choose a patient...</option>
                    </select>
                    <div class="mt-2">
                        <button type="button" class="btn btn-primary btn-sm" onclick="showPatientManagement()" data-translate="add_new_patient">
                            <svg class="icon-sm mr-1" viewBox="0 0 24 24">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                            Add New Patient
                        </button>
                    </div>
                </div>

                <!-- Patient Details Display (Read-only) -->
                <div id="selectedPatientDetails" class="hidden">
                    <div class="card p-4 mb-4">
                        <h4 class="font-semibold mb-2" data-translate="selected_patient_details">Selected Patient Details</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <div><strong data-translate="name">Name:</strong> <span id="displayPatientName">-</span></div>
                            <div><strong data-translate="email">Email:</strong> <span id="displayPatientEmail">-</span></div>
                            <div><strong data-translate="phone">Phone:</strong> <span id="displayPatientPhone">-</span></div>
                            <div><strong data-translate="age">Age:</strong> <span id="displayPatientAge">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Hidden inputs for patient data -->
                <input type="hidden" id="patientName" name="patientName">
                <input type="hidden" id="patientEmail" name="patientEmail">
                <input type="hidden" id="patientPhone" name="patientPhone">

                <div class="form-group">
                    <label class="form-label" for="appointmentDate" data-translate="appointment_date">Appointment
                        Date</label>
                    <input type="date" id="appointmentDate" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="appointmentTime" data-translate="appointment_time">Appointment
                        Time</label>
                    <select id="appointmentTime" class="form-input" required>
                        <option value="">Select time</option>
                        <option value="09:00">9:00 AM</option>
                        <option value="09:30">9:30 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="10:30">10:30 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="11:30">11:30 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="12:30">12:30 PM</option>
                        <option value="13:00">1:00 PM</option>
                        <option value="13:30">1:30 PM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="14:30">2:30 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="15:30">3:30 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="16:30">4:30 PM</option>
                        <option value="17:00">5:00 PM</option>
                        <option value="17:30">5:30 PM</option>
                    </select>
                </div>


                <div class="form-group">
                    <label class="form-label" for="appointmentType" data-translate="appointment_type">Appointment
                        Type</label>
                    <select id="appointmentType" class="form-input" required>
                        <option value="" data-translate="select_type">Select type</option>
                        <option value="Consultation" data-translate="general_consultation">General Consultation</option>
                        <option value="Follow-up" data-translate="follow_up_visit">Follow-up Visit</option>
                        <option value="Check-up" data-translate="regular_checkup">Regular Check-up</option>
                        <option value="Emergency" data-translate="emergency_visit">Emergency Visit</option>
                    </select>
                </div>

                <!--<div class="form-group">
                    <label class="form-label" for="doctorName" data-translate="doctor_name">Doctor Name *</label>
                    <input type="hidden" id="doctorName" class="form-input"  value="" placeholder="Enter doctor's name" required>
                </div>-->
                <input type="hidden" id="doctorName" class="form-input" value="doctor"
                    placeholder="Enter doctor's name" data-translate-placeholder="enter_doctor_name">
                <div class="form-group">
                    <label class="form-label" for="appointmentNotes" data-translate="additional_notes">Additional
                        Notes</label>
                    <textarea id="appointmentNotes" class="form-input form-textarea"
                        placeholder="Any specific concerns or symptoms..." data-translate-placeholder="specific_concerns"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddAppointmentModal()"
                        data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="add_appointment">Add
                        Appointment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pre-Invoice Modal (higher z-index so it appears above other modals) -->
    <div class="modal" id="preInvoiceModal" style="z-index: 2500;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="pre_invoice_title">Pré-facture</h2>
                <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="space-y-4 text-sm">
                    <div>
                        <div><strong data-translate="patient">Patient</strong>: <span id="preInvoicePatientName">-</span></div>
                        <div><strong data-translate="consultation_date">Date de consultation</strong>: <span id="preInvoiceConsultationDate">-</span></div>
                    </div>

                    <div class="card p-4">
                        <h4 class="font-semibold mb-2" data-translate="bill_items">Eléments de la consultation</h4>
                        <div id="preInvoiceItemsContainer" class="space-y-1">
                            <!-- Act details will be injected here -->
                        </div>
                    </div>

                    <div class="card p-4">
                        <h4 class="font-semibold mb-2" data-translate="bill_summary">Résumé de la pré-facture</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span data-translate="subtotal">Sous-total :</span>
                                <span id="preInvoiceSubtotal">0.00 TND</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="tax_8_percent">Taxe (8%) :</span>
                                <span id="preInvoiceTax">0.00 TND</span>
                            </div>
                            <div class="flex justify-between font-semibold border-t pt-2">
                                <span data-translate="total">Total :</span>
                                <span id="preInvoiceTotalSummary">0.00 TND</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-2">
                        <div class="flex justify-between mb-1">
                            <span data-translate="amount_paid">Montant payé</span>
                            <span id="preInvoicePaid">0.00 TND</span>
                        </div>
                        <div class="flex justify-between font-semibold">
                            <span data-translate="amount_remaining">Montant restant</span>
                            <span id="preInvoiceRemaining">0.00 TND</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')" data-translate="close">Close</button>
                <button type="button" class="btn btn-primary" onclick="printPreInvoiceModal()" data-translate="create_pre_invoice">Créer pré-facture</button>
            </div>
        </div>
    </div>

    <!-- Consultation Modal (Doctor Only) -->
    <div class="modal" id="consultationModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="new_consultation">New Consultation</h2>
                <button class="modal-close" onclick="closeConsultationModal()">&times;</button>
            </div>
            <form id="consultationForm">
                <div class="form-group">
                    <input type="text" id="consultPatient" class="form-input" disabled readonly placeholder="Patient will be selected from previous modal">
                    <input type="hidden" id="consultPatientId" name="consultPatientId">
                </div>
                
                <!-- Menu Buttons Bar -->
                <div class="consult-menu-bar mb-4 flex flex-nowrap gap-2">
                    <button type="button" class="consult-menu-btn" onclick="showConsultSection('patient')" data-section="patient" style="background: #3b82f6; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.7rem; border: none; cursor: pointer; opacity: 0.8; flex: 1; line-height: 1.3; text-align: center; white-space: nowrap;" data-translate="patient_information">Patient Information</button>
                    <button type="button" class="consult-menu-btn active" onclick="showConsultSection('consultation')" data-section="consultation" style="background: #1f2937; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.7rem; border: none; cursor: pointer; opacity: 1; flex: 1; line-height: 1.3; text-align: center; white-space: nowrap;" data-translate="consultation">Consultation</button>
                    <button type="button" class="consult-menu-btn" onclick="showConsultSection('lab')" data-section="lab" style="background: #86efac; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.7rem; border: none; cursor: pointer; opacity: 0.8; flex: 1; line-height: 1.3; text-align: center; white-space: nowrap;" data-translate="lab_assessment">Lab Assessment</button>
                    <button type="button" class="consult-menu-btn" onclick="showConsultSection('radiology')" data-section="radiology" style="background: #ef4444; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.7rem; border: none; cursor: pointer; opacity: 0.8; flex: 1; line-height: 1.3; text-align: center; white-space: nowrap;" data-translate="radiology_results">Radiology Results</button>
                    <button type="button" class="consult-menu-btn" onclick="showConsultSection('prescription')" data-section="prescription" style="background: #06b6d4; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.7rem; border: none; cursor: pointer; opacity: 0.8; flex: 1; line-height: 1.3; text-align: center; white-space: nowrap;" data-translate="medical_prescription">Medical Prescription</button>
                    <button type="button" class="consult-menu-btn" onclick="showConsultSection('documents')" data-section="documents" style="background: #f97316; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.7rem; border: none; cursor: pointer; opacity: 0.8; flex: 1; line-height: 1.3; text-align: center; white-space: nowrap;" data-translate="medical_documents">Medical Documents</button>
                    <button type="button" class="consult-menu-btn" onclick="showConsultSection('certificate')" data-section="certificate" style="background: #86efac; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.7rem; border: none; cursor: pointer; opacity: 0.8; flex: 1; line-height: 1.3; text-align: center; white-space: nowrap;" data-translate="work_certificate">Work Certificate</button>
                    </div>
                
                <!-- Patient Details Section -->
                <div id="consultSectionPatient" class="consult-section hidden">
                    <div id="consultPatientDetails" class="card p-6 mb-4">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span data-translate="patient_details_title">Patient Details</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="consultPatientDetailsInfo">
                            <!-- Patient details will be loaded here -->
                    </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h4 class="font-semibold mb-2" data-translate="medical_history">Medical History</h4>
                            <div id="consultPatientHistory" class="text-gray-700 text-sm" data-translate="no_history_available">No history available.</div>
                </div>
                    </div>
                </div>
                
                <!-- Consultation Section -->
                <div id="consultSectionConsultation" class="consult-section">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="consultHeight" data-translate="height_cm">Height (cm)</label>
                        <input type="number" id="consultHeight" class="form-input" placeholder="e.g., 175" data-translate-placeholder="height_example" min="50"
                            max="250" step="0.1" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="consultWeight" data-translate="weight_kg">Weight (kg)</label>
                        <input type="number" id="consultWeight" class="form-input" placeholder="e.g., 70.5" data-translate-placeholder="weight_example" min="10"
                            max="300" step="0.1" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="bmi">IMC (BMI)</label>
                    <div class="form-input bg-gray-50 flex items-center gap-2">
                        <span id="consultIMCValue">—</span>
                        <span id="consultBMICategory" class="text-sm text-gray-500">&nbsp;</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="consultTemperature" data-translate="temperature_c">Temperature (°C)</label>
                    <input type="number" id="consultTemperature" class="form-input" placeholder="e.g., 37.0" data-translate-placeholder="temperature_example" min="30" max="45" step="0.1" />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="consultHeartRate" data-translate="heart_rate_bpm">Heart Rate (bpm)</label>
                        <input type="number" id="consultHeartRate" class="form-input" placeholder="e.g., 72" data-translate-placeholder="heart_rate_example" min="30" max="220" step="1" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="consultBloodSugar" data-translate="blood_sugar_mgdl">Blood Sugar (mg/dL)</label>
                        <input type="number" id="consultBloodSugar" class="form-input" placeholder="e.g., 95" data-translate-placeholder="blood_sugar_example" min="40" max="600" step="1" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="consultBloodPressure" data-translate="blood_pressure_mmhg">Blood Pressure (mmHg)</label>
                    <input type="text" id="consultBloodPressure" class="form-input" placeholder="e.g., 120/80" data-translate-placeholder="blood_pressure_example" />
                </div>
                
                <!-- Clinical Note Card -->
                <div class="card p-6 mb-4">
                    <h3 class="text-lg font-semibold mb-4" data-translate="clinical_notes">Clinical Note</h3>
                <div class="form-group">
                        <textarea id="consultNotes" class="form-input form-textarea" placeholder="Enter notes" data-translate-placeholder="enter_notes"></textarea>
                    </div>
                </div>
                
                <!-- Consultation Act (from bill descriptions) -->
                <div class="form-group">
                    <label class="form-label" for="consultationAct" data-translate="consultation_act">Consultation Act</label>
                    <div id="consultationActMultiWrapper" class="relative">
                        <!-- Display selected acts in a user-friendly way -->
                        <div id="consultationActDisplay"
                             class="form-input cursor-pointer flex flex-wrap gap-1 text-gray-700"
                             style="min-height: 2.5rem;">
                        </div>
                        <!-- Advanced dropdown: search + checkbox list (opens above to avoid covering buttons) -->
                        <div id="consultationActMultiPanel"
                             class="absolute bottom-full mb-1 w-full bg-white border border-gray-300 rounded shadow-lg max-h-60 overflow-auto z-30 hidden">
                            <div class="p-2 border-b border-gray-200">
                                <input type="text"
                                       id="consultationActMultiSearch"
                                       class="form-input text-sm"
                                       placeholder="Search service..."
                                       data-translate-placeholder="search_service">
                            </div>
                            <div id="consultationActMultiList" class="p-2 space-y-1">
                                <!-- Options will be rendered here by JS -->
                            </div>
                        </div>
                        <!-- Underlying select kept for compatibility with existing logic -->
                        <select id="consultationAct" class="form-input mt-2 hidden" multiple size="6">
                            <!-- Options will be populated from bill descriptions via JS -->
                        </select>
                    </div>
                </div>
                
                <!-- Payment Status -->
                <div class="form-group">
                    <label class="form-label" data-translate="payment_status">Payment Status</label>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                           <input type="radio" name="paymentStatus" value="paying" id="payingPatient" class="form-radio" checked>
                            <span data-translate="paying_patient">Paying Patient</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="paymentStatus" value="non-paying" id="nonPayingPatient" class="form-radio">
                            <span data-translate="non_paying_patient">Non-Paying Patient</span>
                        </label>
                    </div>
                </div>
                </div>
                
                <!-- Lab Assessment Section -->
                <div id="consultSectionRadiology" class="consult-section hidden">
                    <div class="mb-4">
                        <!-- Diagnostics Input -->
                        <div class="mb-4">
                            <div class="flex flex-wrap items-center justify-between gap-3 bg-blue-600 text-white px-4 py-2 rounded-t-lg">
                                <h3 class="font-semibold" data-translate="diagnostics">Diagnostics</h3>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="uploadRadiologySection('diagnostics')" data-translate="upload">Upload</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="printRadiologySection('diagnostics')" data-translate="print">Print</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="saveRadiologySection('diagnostics')" data-translate="save">Save</button>
                                </div>
                            </div>
                            <textarea id="radiologyDiagnostics" class="w-full border border-gray-300 rounded-b-lg p-4 min-h-[200px] focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter diagnostics..." data-translate-placeholder="enter_diagnostics"></textarea>
                        </div>
                        
                        <!-- Radiology Result Input -->
                        <div>
                            <div class="flex flex-wrap items-center justify-between gap-3 bg-blue-600 text-white px-4 py-2 rounded-t-lg">
                                <h3 class="font-semibold" data-translate="radiology_result">Radiology Result</h3>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="uploadRadiologySection('result')" data-translate="upload">Upload</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="printRadiologySection('result')" data-translate="print">Print</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="saveRadiologySection('result')" data-translate="save">Save</button>
                                </div>
                            </div>
                            <textarea id="radiologyResult" class="w-full border border-gray-300 rounded-b-lg p-4 min-h-[200px] focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter radiology result..." data-translate-placeholder="enter_radiology_result"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Lab Results Section -->
                <div id="consultSectionLab" class="consult-section hidden">
                    <div class="mb-4">
                        <!-- Lab Notes/Observations Input -->
                        <div class="mb-4">
                            <div class="flex flex-wrap items-center justify-between gap-3 bg-blue-600 text-white px-4 py-2 rounded-t-lg">
                                <h3 class="font-semibold" data-translate="lab_notes">Lab Notes</h3>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="uploadLabSection('notes')" data-translate="upload">Upload</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="printLabSection('notes')" data-translate="print">Print</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="saveLabSection('notes')" data-translate="save">Save</button>
                                </div>
                            </div>
                            <textarea id="labNotes" class="w-full border border-gray-300 rounded-b-lg p-4 min-h-[200px] focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter lab notes and observations..." data-translate-placeholder="enter_lab_notes"></textarea>
                        </div>
                        
                        <!-- Lab Results Input -->
                        <div>
                            <div class="flex flex-wrap items-center justify-between gap-3 bg-blue-600 text-white px-4 py-2 rounded-t-lg">
                                <h3 class="font-semibold" data-translate="lab_results">Lab Results</h3>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="uploadLabSection('results')" data-translate="upload">Upload</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="printLabSection('results')" data-translate="print">Print</button>
                                    <button type="button" class="px-3 py-1 text-xs font-semibold uppercase tracking-wide rounded-full bg-white bg-opacity-20 hover:bg-white hover:text-blue-700 transition-colors" onclick="saveLabSection('results')" data-translate="save">Save</button>
                                </div>
                            </div>
                            <textarea id="labResults" class="w-full border border-gray-300 rounded-b-lg p-4 min-h-[200px] focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter lab results..." data-translate-placeholder="enter_lab_results"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Prescription Section -->
                <div id="consultSectionPrescription" class="consult-section hidden">
                    <!-- Medical Prescription Card -->
                    <div class="card p-6 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold" data-translate="medical_prescription">Medical Prescription</h3>
                            <div class="flex items-center gap-2">
                                <button type="button" onclick="printPrescriptionMedicinesList()" class="btn btn-primary btn-sm flex items-center gap-2" data-translate="print">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                                    <span data-translate="print">Print</span>
                        </button>
                                <button type="button" onclick="clearPrescriptionMedicinesList()" class="btn btn-secondary btn-sm flex items-center gap-2" data-translate="clear">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                                    <span data-translate="clear">Clear</span>
                        </button>
                            </div>
                        </div>
                        
                        <!-- Add Medicine -->
                        <div class="mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3 items-end">
                                <div class="form-group">
                                    <label class="form-label" for="prescriptionMedicineSelect" data-translate="select_medicine">Select Medicine</label>
                                    <select id="prescriptionMedicineSelect" class="form-input">
                                        <option value="" data-translate="select_medicine">Select medicine...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="prescriptionDosage" data-translate="dosage">Dosage</label>
                                    <select id="prescriptionDosage" class="form-input">
                                        <option value="">Select dosage...</option>
                                        <option value="once daily">1x daily</option>
                                        <option value="twice daily">2x daily</option>
                                        <option value="three times daily">3x daily</option>
                                        <option value="four times daily">4x daily</option>
                                        <option value="every 6 hours">Every 6 hours</option>
                                        <option value="every 8 hours">Every 8 hours</option>
                                        <option value="every 12 hours">Every 12 hours</option>
                                        <option value="once weekly">Once weekly</option>
                                        <option value="as needed">As needed (PRN)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="prescriptionInstructions" data-translate="instructions">Instructions</label>
                                    <input type="text" id="prescriptionInstructions" class="form-input" placeholder="e.g., after meals">
                                </div>
                                <div class="form-group flex items-end">
                                    <button type="button" id="addMedicineToPrescriptionBtn" class="btn btn-primary w-full whitespace-nowrap flex items-center justify-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                                        <span data-translate="add_medicine">Add Medicine</span>
                        </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prescription List -->
                        <div id="prescriptionListContainer" class="space-y-2 mb-4">
                            <!-- Medicines will be added here -->
                        </div>
                        
                        <!-- Prescription Text Area (auto-generated from medicines, read-only) -->
                        <div class="form-group">
                            <label class="form-label" for="consultPrescription" data-translate="prescription">Prescription</label>
                            <textarea id="consultPrescription" class="form-input form-textarea" rows="6"
                                placeholder="Drugs, dosage, duration" data-translate-placeholder="drugs_dosage" readonly></textarea>
                        </div>
                        
                        <!-- Prescription Information -->
                        <div class="card p-3 bg-yellow-50 border-yellow-200 mb-4">
                            <div class="flex items-start gap-2">
                                <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-semibold mb-1" data-translate="prescription_info">Prescription Information</p>
                                    <p data-translate="prescription_info_text">After saving, you can view and print the prescription from the consultation details.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Documents Section -->
                <div id="consultSectionDocuments" class="consult-section hidden">
                    <div class="card p-6 mb-4">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span data-translate="medical_documents">Medical Documents</span>
                        </h3>
                        
                        <!-- File Upload Area -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="upload_document">Upload Document</label>
                            <div class="flex items-center gap-3">
                                <input type="file" id="consultDocumentUpload" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt" multiple onchange="handleConsultationDocumentUpload(event)">
                                <button type="button" onclick="document.getElementById('consultDocumentUpload').click()" class="btn btn-primary flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <span data-translate="select_files">Select Files</span>
                        </button>
                                <span class="text-sm text-gray-500" data-translate="supported_formats">Supported: PDF, DOC, DOCX, JPG, PNG, GIF, TXT</span>
                    </div>
                </div>
                
                        <div id="consultDocumentsList" class="space-y-3">
                            <!-- Documents will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Work Certificate Section -->
                <div id="consultSectionCertificate" class="consult-section hidden">
                    <div id="consultCertificateForm">
                        <input type="hidden" id="consultCertConsultationId">
                        
                        <!-- Rest Period (for sick leave) -->
                <div class="form-group">
                            <label class="form-label font-semibold" data-translate="rest_period">Rest Period (Days)</label>
                            <input type="number" id="consultCertRestPeriod" class="form-input" min="1" max="365" data-translate-placeholder="rest_period_placeholder" placeholder="e.g., 7">
                </div>
                
                        <!-- Start Date -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                                <label class="form-label font-semibold" for="consultCertStartDate" data-translate="start_date">Start Date</label>
                                <input type="date" id="consultCertStartDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label font-semibold" for="consultCertEndDate" data-translate="end_date">End Date</label>
                                <input type="date" id="consultCertEndDate" class="form-input">
                            </div>
                        </div>
                        
                        
                        
                        <!-- Preview/Print Option -->
                        
                        <!-- Print Button -->
                        <div class="flex justify-end gap-3 mb-4">
                            <button type="button" class="btn btn-primary" onclick="printCertificateFromForm()" data-translate="print_certificate">
                                <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                <span data-translate="print_certificate">Print Certificate</span>
                            </button>
                        </div>
                        
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeConsultationModal()" data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save_consultation">Save Consultation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Management Modal -->
    <div class="modal" id="patientManagementModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="patient_management">Patient Management</h2>
                <button class="modal-close" onclick="closePatientManagement()">&times;</button>
            </div>

            <div class="flex gap-4 mb-6">
                <button id="addPatientTab" class="btn btn-primary" onclick="switchPatientTab('add')"
                    data-translate="add_new_patient" data-permission="add_patients">Add New Patient</button>
                <button id="viewPatientsTab" class="btn btn-secondary" onclick="switchPatientTab('view')"
                    data-translate="view_all_patients">View All Patients</button>
            </div>

            <!-- Add Patient Form -->
            <div id="addPatientContent" class="patient-tab-content">
                <form id="patientForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="patientFileNumber"
                                data-translate="patient_file_number">Patient File Number *</label>
                            <input type="text" id="patientFileNumber" class="form-input"
                                data-translate-placeholder="file_number_example"
                                placeholder="Enter patient file number (e.g., P-2024-001)" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientCinPassport" data-translate="cin_passport">CIN or
                                Passeport *</label>
                            <input type="text" id="patientCinPassport" class="form-input"
                                data-translate-placeholder="cin_passport_example"
                                placeholder="Enter CIN or Passport number" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientFullName" data-translate="full_name">Full Name
                                *</label>
                            <input type="text" id="patientFullName" class="form-input"
                                data-translate-placeholder="full_name_example"
                                placeholder="Enter patient's full name" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientEmailAddress" data-translate="email_address">Email
                                Address</label>
                            <input type="email" id="patientEmailAddress" class="form-input"
                                data-translate-placeholder="email_example"
                                placeholder="patient@example.com">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientPhoneNumber" data-translate="phone_number">Phone
                                Number *</label>
                            <input type="tel" id="patientPhoneNumber" class="form-input" 
                                data-translate-placeholder="phone_example"
                                placeholder="20 123 456" required
                                maxlength="8" pattern="[0-9]{8}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientDateOfBirth" data-translate="date_of_birth">Date of
                                Birth *</label>
                            <input type="date" id="patientDateOfBirth" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientGender" data-translate="gender">Gender</label>
                            <select id="patientGender" class="form-input">
                                <option value="" data-translate="select_gender">Select gender</option>
                                <option value="Male" data-translate="male">Male</option>
                                <option value="Female" data-translate="female">Female</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientAddress" data-translate="address">Address</label>
                            <input type="text" id="patientAddress" class="form-input"
                                data-translate-placeholder="address_example"
                                placeholder="Street address, City, State">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="patientMedicalHistory" data-translate="medical_history">Medical
                            History / Notes</label>
                        <textarea id="patientMedicalHistory" class="form-input form-textarea"
                            placeholder="Any relevant medical history, allergies, or notes..."></textarea>
                    </div>

                    <!-- Patient Documents Section -->
                    <div class="form-group">
                        <label class="form-label" data-translate="patient_documents">Patient Documents</label>
                        <div class="card p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="upload_document">Upload Document</label>
                                <div class="flex items-center gap-3">
                                    <input type="file" id="patientDocumentUpload" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt" multiple onchange="handlePatientDocumentUpload(event)">
                                    <button type="button" onclick="document.getElementById('patientDocumentUpload').click()" class="btn btn-primary flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <span data-translate="select_files">Select Files</span>
                                    </button>
                                    <span class="text-sm text-gray-500" data-translate="supported_formats">Supported: PDF, DOC, DOCX, JPG, PNG, GIF, TXT</span>
                                </div>
                            </div>
                            
                            <div id="patientFormDocumentsList" class="space-y-3">
                                <!-- Documents will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePatientManagement()"
                            data-translate="cancel">Cancel</button>
                        <button type="submit" class="btn btn-primary" data-translate="add_patient">Add Patient</button>
                    </div>
                </form>
            </div>

            <!-- View Patients Content -->
            <div id="viewPatientsContent" class="patient-tab-content" style="display: none;">
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="patientSearch" class="form-input pr-10"
                            data-translate-placeholder="search_patients"
                            placeholder="Search patients by name, CIN/Passport, file number, email, phone, or date of birth..."
                            onkeyup="searchPatients()">
                        <button type="button" id="clearSearch"
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                            onclick="clearPatientSearch()" style="display: none;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="searchResults" class="text-sm text-gray-600 mt-2" style="display: none;"></div>
                </div>

                <div id="patientsList" class="space-y-4">
                    <!-- Patients will be loaded here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Edit Patient Modal -->
    <div class="modal" id="editPatientModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="edit_patient">Edit Patient</h2>
                <button class="modal-close" onclick="closeEditPatientModal()">&times;</button>
            </div>

            <form id="editPatientForm">
                <input type="hidden" id="editPatientId" name="patientId">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="editPatientFileNumber"
                            data-translate="patient_file_number">Patient File Number *</label>
                        <input type="text" id="editPatientFileNumber" class="form-input bg-gray-100 cursor-not-allowed" readonly disabled
                            data-translate-placeholder="file_number_example"
                            placeholder="Enter patient file number (e.g., P-2024-001)" title="Auto-generated; not editable" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editPatientCinPassport" data-translate="cin_passport">CIN or
                            Passeport *</label>
                        <input type="text" id="editPatientCinPassport" class="form-input"
                            data-translate-placeholder="cin_passport_example"
                            placeholder="Enter CIN or Passport number" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editPatientFullName" data-translate="full_name">Full Name
                            *</label>
                        <input type="text" id="editPatientFullName" class="form-input"
                            data-translate-placeholder="full_name_example"
                            placeholder="Enter patient's full name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editPatientEmailAddress" data-translate="email_address">Email
                            Address</label>
                        <input type="email" id="editPatientEmailAddress" class="form-input"
                            data-translate-placeholder="email_example"
                            placeholder="patient@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editPatientPhoneNumber" data-translate="phone_number">Phone
                            Number *</label>
                        <input type="tel" id="editPatientPhoneNumber" class="form-input" 
                            data-translate-placeholder="phone_example"
                            placeholder="+216 20 123 456" required
                            maxlength="8" pattern="[0-9]{8}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editPatientDateOfBirth" data-translate="date_of_birth">Date of
                            Birth *</label>
                        <input type="date" id="editPatientDateOfBirth" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editPatientGender" data-translate="gender">Gender</label>
                        <select id="editPatientGender" class="form-input">
                            <option value="" data-translate="select_gender">Select gender</option>
                            <option value="Male" data-translate="male">Male</option>
                            <option value="Female" data-translate="female">Female</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editPatientAddress" data-translate="address">Address</label>
                        <input type="text" id="editPatientAddress" class="form-input"
                            data-translate-placeholder="address_example"
                            placeholder="Street address, City, State">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editPatientMedicalHistory" data-translate="medical_history">Medical
                        History / Notes</label>
                    <textarea id="editPatientMedicalHistory" class="form-input form-textarea"
                        placeholder="Any relevant medical history, allergies, or notes..."></textarea>
                </div>

                <!-- Patient Documents (Edit) -->
                <div class="form-group">
                    <label class="form-label" data-translate="patient_documents">Patient Documents</label>
                    <div class="card p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="upload_document">Upload Document</label>
                            <div class="flex items-center gap-3">
                                <input type="file" id="editPatientDocumentUpload" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt" multiple onchange="handleEditPatientDocumentUpload(event)">
                                <button type="button" onclick="document.getElementById('editPatientDocumentUpload').click()" class="btn btn-primary flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <span data-translate="select_files">Select Files</span>
                                </button>
                                <span class="text-sm text-gray-500" data-translate="supported_formats">Supported: PDF, DOC, DOCX, JPG, PNG, GIF, TXT</span>
                            </div>
                        </div>

                        <div id="editPatientDocumentsList" class="space-y-3">
                            <!-- Documents will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Medical Files Management Section -->
                <div class="form-group">
                    <label class="form-label" data-translate="medical_files">Medical Files</label>

                    <!-- Current Files Display -->
                    <div id="editCurrentFiles" class="mb-4">
                        <!-- Current files will be displayed here -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPatientModal()"
                        data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="update_patient">Update
                        Patient</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Details Modal (Secretary View with Past Consultations) -->
    <div class="modal" id="patientDetailsModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="patient_details_title">Patient Details & Consultation History</h2>
                <button class="modal-close" onclick="closePatientDetailsModal()">&times;</button>
            </div>

            <div class="space-y-6">
                <!-- Patient Information Section -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span data-translate="patient_information">Patient Information</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="patientDetailsInfo">
                        <!-- Patient details will be loaded here -->
                    </div>
                </div>

                <!-- Past Consultations Section -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between cursor-pointer" onclick="toggleAccordion('consultationsAccordion')">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <span data-translate="past_consultations">Past Consultations</span>
                        </div>
                        <svg id="consultationsAccordionIcon" class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </h3>
                    <div id="consultationsAccordion" class="hidden space-y-4">
                        <div id="patientConsultationsList" class="space-y-4">
                            <!-- Consultations will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Past Bills Section -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between cursor-pointer" onclick="toggleAccordion('billsAccordion')">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"></path>
                            </svg>
                            <span data-translate="past_bills">Past Bills</span>
                        </div>
                        <svg id="billsAccordionIcon" class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </h3>
                    <div id="billsAccordion" class="hidden space-y-4">
                        <div id="patientBillsList" class="space-y-4">
                            <!-- Bills will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Patient Documents Section -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between cursor-pointer" onclick="toggleAccordion('documentsAccordion')">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span data-translate="patient_documents">Patient Documents</span>
                        </div>
                        <svg id="documentsAccordionIcon" class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </h3>
                    <div id="documentsAccordion" class="hidden space-y-4">
                        <div id="patientDocumentsList">
                            <!-- Patient documents will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Medical Files Section (if any) -->
                <div class="card p-6" id="patientFilesSection" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span data-translate="medical_files">Medical Files</span>
                    </h3>
                    <div id="patientFilesList">
                        <!-- Medical files will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="modal-actions mt-6">
                <button type="button" class="btn btn-secondary" onclick="closePatientDetailsModal()" data-translate="close">Close</button>
                <button type="button" class="btn btn-primary" onclick="editPatientFromDetails()" data-translate="edit_patient">Edit Patient</button>
            </div>
        </div>
    </div>

    <!-- Patient Document Preview Modal -->
    <div class="modal" id="patientDocumentPreviewModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="document_preview">Document Preview</h2>
                <button class="modal-close" onclick="closePatientDocumentPreviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="patientDocumentPreviewContent">
                    <!-- Document content will be loaded here -->
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closePatientDocumentPreviewModal()" data-translate="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Billing Modal -->
    <div class="modal" id="billingModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="create_patient_bill">Create Patient Bill</h2>
                <button class="modal-close" onclick="closeBillingModal()">&times;</button>
            </div>

            <form id="billingForm">
                <!-- Patient Details Display (Read-only) -->
                <div id="billPatientDetails">
                    <div class="form-group">
                        <label class="form-label" data-translate="patient">Patient</label>
                        <input type="text" id="billPatientDisplay" class="form-input bg-gray-100 cursor-not-allowed" disabled readonly placeholder="Patient name will appear here...">
                    </div>
                    <div class="card p-4 mb-4">
                        <h4 class="font-semibold mb-2">Patient Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <div><strong>Name:</strong> <span id="billPatientName">-</span></div>
                            <div><strong>Email:</strong> <span id="billPatientEmail">-</span></div>
                            <div><strong>Phone:</strong> <span id="billPatientPhone">-</span></div>
                            <div><strong>Address:</strong> <span id="billPatientAddress">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Hidden inputs for patient data -->
                <input type="hidden" id="billPatientId" name="patientId">
                <input type="hidden" id="billPatientFullName" name="patientName">
                <input type="hidden" id="billPatientEmailAddress" name="patientEmail">
                <input type="hidden" id="billPatientPhoneNumber" name="patientPhone">
                <input type="hidden" id="billConsultationId" name="consultationId">


                <div class="form-group">
                    <label class="form-label" for="billDueDate" data-translate="due_date">Due Date</label>
                    <input type="date" id="billDueDate" class="form-input" required>
                </div>

                <!-- Bill Items Section -->
                <div class="form-group">
                    <label class="form-label" data-translate="bill_items">Bill Items</label>
                    <div id="billItems" class="space-y-3">
                        <div class="bill-item border border-gray-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="form-label" for="itemDescription1"
                                        data-translate="description">Description</label>
                                    <select id="itemDescription1" class="form-input" required onchange="autoFillPrice(this)">
                                        <option value="" data-translate="select_service">Select service...</option>
                                    </select>
                                </div>
                                <div style="display: none;">
                                    <label class="form-label" for="itemQuantity1"
                                        data-translate="quantity">Quantité</label>
                                    <input type="number" id="itemQuantity1" class="form-input" min="1" value="1"
                                        required onchange="calculateBillTotal()" oninput="calculateBillTotal()">
                                </div>
                                <div>
                                    <label class="form-label" for="itemPrice1" data-translate="price">Prix (TND)</label>
                                    <input type="number" id="itemPrice1" class="form-input" min="0" step="0.01"
                                        placeholder="0.00" data-translate-placeholder="price_placeholder" required onchange="calculateBillTotal()"
                                        oninput="calculateBillTotal()">
                                </div>
                            </div>
                            <div class="mt-2 flex justify-end">
                                <button type="button" class="btn btn-outline btn-sm text-red-600 hover:text-red-700 hover:bg-red-50 border-red-300 hover:border-red-400" onclick="removeBillItem(this)" title="Remove Item">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm mt-3" onclick="addBillItem()">
                        <svg class="icon-sm mr-1" viewBox="0 0 24 24">
                            <path d="M12 4v16m8-8H4" />
                        </svg>
                        <span data-translate="add_item">Add Item</span>
                    </button>
                </div>

                <!-- Bill Summary -->
                <div class="card p-4 mb-4">
                    <h4 class="font-semibold mb-2" data-translate="bill_summary">Bill Summary</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span data-translate="subtotal">Subtotal:</span>
                            <span id="billSubtotal">0.00 TND</span>
                        </div>
                        <div class="flex justify-between">
                            <span data-translate="tax_8_percent">Tax (8%):</span>
                            <span id="billTax">0.00 TND</span>
                        </div>
                        <div class="flex justify-between font-semibold text-lg border-t pt-2">
                            <span data-translate="total">Total:</span>
                            <span id="billTotal">0.00 TND</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="billNotes" data-translate="notes">Notes</label>
                    <textarea id="billNotes" class="form-input form-textarea"
                        placeholder="Additional notes or payment instructions..." data-translate-placeholder="bill_notes_placeholder"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBillingModal()"
                        data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="create_bill">Create Bill</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ready Bills Modal (Secretary) -->
    <div class="modal" id="readyBillsModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="billing_management">Billing Management</h2>
                <button class="modal-close" onclick="closeReadyBillsModal()">&times;</button>
            </div>

            <!-- Tabs for Payment, Ready Bills and Done Bills -->
            <div class="flex gap-4 mb-6">
                <button id="paymentBillsTab" class="btn btn-secondary" onclick="switchBillsTab('payment')"
                    data-translate="payment_tab">Payment</button>
                <button id="readyBillsTab" class="btn btn-primary" onclick="switchBillsTab('ready')"
                    data-translate="ready_bills">Ready Bills</button>
                <button id="doneBillsTab" class="btn btn-secondary" onclick="switchBillsTab('done')"
                    data-translate="done_bills">Done Bills</button>
            </div>

            <div class="modal-body space-y-4">
                <!-- Payment Tab Content -->
                <div id="paymentBillsContent" class="space-y-3" style="display: none;">
                    <!-- Consultations list for Payment tab -->
                    <div id="paymentConsultationsContainer" class="space-y-3"></div>
                </div>

                <!-- Ready Bills Content -->
                <div id="readyBillsContent" class="space-y-3">
                    <div id="readyBillsContainer" class="space-y-3"></div>
                </div>

                <!-- Done Bills Content -->
                <div id="doneBillsContent" class="space-y-3" style="display: none;">
                    <div class="mb-4">
                        <input type="text" id="billSearch" class="form-input" 
                            placeholder="Search bills by patient name, bill ID, or status..."
                            data-translate-placeholder="search_bills_placeholder"
                            onkeyup="searchDoneBills()">
                    </div>
                    <div id="doneBillsContainer" class="space-y-3"></div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeReadyBillsModal()" data-translate="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Menu Modal -->
    <div class="modal" id="settingsMenuModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="settings">Settings</h2>
                <button class="modal-close" onclick="closeSettingsMenu()">&times;</button>
            </div>

            <div class="p-6">
                <div class="space-y-3">
                    <button class="w-full btn btn-outline text-left flex items-center justify-between p-4 hover:bg-gray-50" onclick="openLanguageSettings()">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                            </svg>
                            <div>
                                <div class="font-semibold" data-translate="language_settings">Language Settings</div>
                                <div class="text-sm text-gray-500" data-translate="manage_language">Change application language</div>
                            </div>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button class="w-full btn btn-outline text-left flex items-center justify-between p-4 hover:bg-gray-50" onclick="openBillDescriptionsManagement()">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold" data-translate="bill_descriptions">Bill Descriptions</div>
                                <div class="text-sm text-gray-500" data-translate="manage_bill_descriptions">Manage billing service items</div>
                            </div>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button class="w-full btn btn-outline text-left flex items-center justify-between p-4 hover:bg-gray-50" onclick="showMedicinesModal()">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold" data-translate="medicines_management">Medicines Management</div>
                                <div class="text-sm text-gray-500" data-translate="manage_medicines">Manage medicines list for prescriptions</div>
                            </div>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button class="w-full btn btn-outline text-left flex items-center justify-between p-4 hover:bg-gray-50" onclick="openCabinetSettings()">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <div>
                                <div class="font-semibold" data-translate="cabinet_settings">Cabinet Settings</div>
                                <div class="text-sm text-gray-500" data-translate="manage_cabinet_info">Manage cabinet name, logo & schedule</div>
                            </div>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button class="w-full btn btn-outline text-left flex items-center justify-between p-4 hover:bg-gray-50" 
                        id="settings-user-management" data-permission="manage_users" onclick="openUserManagement()">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold" data-translate="user_management">User Management</div>
                                <div class="text-sm text-gray-500" data-translate="manage_users_access">Manage users and their access</div>
                            </div>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <button class="w-full btn btn-outline text-left flex items-center justify-between p-4 hover:bg-gray-50"
                        id="settings-export-backup" data-permission="export_reports" onclick="exportFullBackupForCurrentMonth()">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v4H4zM4 10h16v10H4zM9 14h2v4H9zM13 14h2v4h-2z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold" data-translate="export_full_backup">Export all data</div>
                                <div class="text-sm text-gray-500" data-translate="export_full_backup_hint">Download a full SQL backup of all data</div>
                            </div>
                        </div>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSettingsMenu()"
                    data-translate="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Language Settings Modal -->
    <div class="modal" id="languageSettingsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="language_settings">Language Settings</h2>
                <button class="modal-close" onclick="closeLanguageSettings()">&times;</button>
            </div>

            <div class="p-6">
                <div class="form-group">
                    <label class="form-label" data-translate="select_language">Select Language:</label>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input type="radio" id="lang-en" name="language" value="en" class="mr-3"
                                onchange="switchToLanguage('en')" onclick="switchToLanguage('en')">
                            <label for="lang-en" class="flex items-center cursor-pointer" onclick="switchToLanguage('en')">
                                <span class="text-2xl mr-2">🇺🇸</span>
                                <span data-translate="english">English</span>
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="lang-fr" name="language" value="fr" class="mr-3"
                                onchange="switchToLanguage('fr')" onclick="switchToLanguage('fr')">
                            <label for="lang-fr" class="flex items-center cursor-pointer" onclick="switchToLanguage('fr')">
                                <span class="text-2xl mr-2">🇫🇷</span>
                                <span data-translate="french">Français</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeLanguageSettings()"
                        data-translate="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Descriptions Management Modal -->
    <div class="modal" id="billDescriptionsModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="bill_descriptions">Bill Descriptions Management</h2>
                <button class="modal-close" onclick="closeBillDescriptionsModal()">&times;</button>
            </div>

            <div class="p-6">
                <!-- Add New Description Form -->
                <div class="card p-4 mb-6">
                    <h3 class="font-semibold mb-4" data-translate="add_new_description">Add New Service</h3>
                    <form id="addDescriptionForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="newDescriptionName" data-translate="service_name">Service Name *</label>
                            <input type="text" id="newDescriptionName" class="form-input" required placeholder="e.g., General Consultation">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="newDescriptionPrice" data-translate="default_price">Default Price (TND) *</label>
                            <input type="number" id="newDescriptionPrice" class="form-input" min="0" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group flex items-end">
                            <button type="submit" class="btn btn-primary w-full">
                                <svg class="icon-sm mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                <span data-translate="add_service">Add Service</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Existing Descriptions List -->
                <div class="card p-4">
                    <h3 class="font-semibold mb-4" data-translate="existing_services">Existing Services</h3>
                    <div class="mb-3">
                        <input type="text" id="descriptionSearch" class="form-input" 
                            placeholder="Search services..."
                            onkeyup="searchBillDescriptions()" data-translate-placeholder="search_services">
                    </div>
                    <div id="descriptionsListContainer" class="space-y-2">
                        <!-- List will be populated here -->
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeBillDescriptionsModal()"
                    data-translate="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Bill Description Modal -->
    <div class="modal" id="editDescriptionModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="edit_service">Edit Service</h2>
                <button class="modal-close" onclick="closeEditDescriptionModal()">&times;</button>
            </div>

            <form id="editDescriptionForm" class="p-6">
                <input type="hidden" id="editDescriptionId">
                
                <div class="form-group">
                    <label class="form-label" for="editDescriptionName" data-translate="service_name">Service Name *</label>
                    <input type="text" id="editDescriptionName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editDescriptionPrice" data-translate="default_price">Default Price (TND) *</label>
                    <input type="number" id="editDescriptionPrice" class="form-input" min="0" step="0.01" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditDescriptionModal()"
                        data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save_changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Medicines Management Modal -->
    <div class="modal" id="medicinesModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="medicines_management">Medicines Management</h2>
                <button class="modal-close" onclick="closeMedicinesModal()">&times;</button>
            </div>

            <div class="p-6">
                <!-- Add New Medicine Form -->
                <div class="card p-4 mb-6">
                    <h3 class="font-semibold mb-4" data-translate="add_new_medicine">Add New Medicine</h3>
                    <form id="addMedicineForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="newMedicineName" data-translate="medicine_name">Medicine Name *</label>
                            <input type="text" id="newMedicineName" class="form-input" required placeholder="e.g., Paracetamol">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="newMedicineDosage" data-translate="dosage">Dosage (Optional)</label>
                            <input type="text" id="newMedicineDosage" class="form-input" placeholder="e.g., 500mg, 2x daily">
                        </div>
                        <div class="form-group flex items-end">
                            <button type="submit" class="btn btn-primary w-full">
                                <svg class="icon-sm mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                <span data-translate="add_medicine">Add Medicine</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Existing Medicines List -->
                <div class="card p-4">
                    <h3 class="font-semibold mb-4" data-translate="existing_medicines">Existing Medicines</h3>
                    <div class="mb-3">
                        <input type="text" id="medicineSearch" class="form-input" 
                            placeholder="Search medicines..."
                            onkeyup="searchMedicines()" data-translate-placeholder="search_medicines">
                    </div>
                    <div id="medicinesListContainer" class="space-y-2">
                        <!-- List will be populated here -->
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeMedicinesModal()"
                    data-translate="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Medicine Modal -->
    <div class="modal" id="editMedicineModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="edit_medicine">Edit Medicine</h2>
                <button class="modal-close" onclick="closeEditMedicineModal()">&times;</button>
            </div>

            <form id="editMedicineForm" class="p-6">
                <input type="hidden" id="editMedicineId">
                
                <div class="form-group">
                    <label class="form-label" for="editMedicineName" data-translate="medicine_name">Medicine Name *</label>
                    <input type="text" id="editMedicineName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editMedicineDosage" data-translate="dosage">Dosage (Optional)</label>
                    <input type="text" id="editMedicineDosage" class="form-input">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditMedicineModal()"
                        data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save_changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cabinet Settings Modal -->
    <div class="modal" id="cabinetSettingsModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="cabinet_settings">Cabinet Settings</h2>
                <button class="modal-close" onclick="closeCabinetSettings()">&times;</button>
            </div>

            <form id="cabinetSettingsForm" class="p-6">
                <!-- Cabinet Name Section -->
                <div class="card p-4 mb-6">
                    <h3 class="font-semibold mb-4" data-translate="cabinet_information">Cabinet Information</h3>
                    <div class="form-group">
                        <label class="form-label" for="cabinetName" data-translate="cabinet_name">Cabinet Name *</label>
                        <input type="text" id="cabinetName" class="form-input" required placeholder="e.g., Dr. Smith Medical Center">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="cabinetAddress" data-translate="cabinet_address">Cabinet Address</label>
                        <textarea id="cabinetAddress" class="form-input form-textarea" rows="2" placeholder="Street address, city, postal code"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinetPhone" data-translate="cabinet_phone">Cabinet Phone</label>
                        <input type="tel" id="cabinetPhone" class="form-input" placeholder="+1 234 567 890">
                    </div>
                </div>

                <!-- Logo Section -->
                <div class="card p-4 mb-6">
                    <h3 class="font-semibold mb-4" data-translate="cabinet_logo">Cabinet Logo</h3>
                    <div class="flex items-start gap-4">
                        <div id="logoPreview" class="flex-shrink-0 w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="cabinetLogoInput" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
                            <button type="button" class="btn btn-outline mb-2" onclick="document.getElementById('cabinetLogoInput').click()">
                                <svg class="icon-sm mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                                <span data-translate="upload_logo">Upload Logo</span>
                            </button>
                            <button type="button" class="btn btn-outline text-red-600" onclick="removeLogo()">
                                <svg class="icon-sm mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                <span data-translate="remove_logo">Remove Logo</span>
                            </button>
                            <p class="text-sm text-gray-500 mt-2" data-translate="logo_recommendation">Recommended: Square image, max 2MB</p>
                        </div>
                    </div>
                </div>

                <!-- Timetable Section -->
                <div class="card p-4 mb-6">
                    <h3 class="font-semibold mb-4" data-translate="cabinet_timetable">Working Hours / Timetable</h3>
                    <div class="space-y-3">
                        <!-- Monday -->
                        <div class="flex items-center gap-3">
                            <div class="w-32">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="monday_enabled" class="mr-2" checked onchange="toggleDaySchedule('monday')">
                                    <span class="font-medium" data-translate="monday">Monday</span>
                                </label>
                            </div>
                            <div id="monday_schedule" class="flex-1 flex items-center gap-2">
                                <input type="time" id="monday_open" class="form-input" value="09:00">
                                <span>-</span>
                                <input type="time" id="monday_close" class="form-input" value="17:00">
                            </div>
                        </div>

                        <!-- Tuesday -->
                        <div class="flex items-center gap-3">
                            <div class="w-32">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="tuesday_enabled" class="mr-2" checked onchange="toggleDaySchedule('tuesday')">
                                    <span class="font-medium" data-translate="tuesday">Tuesday</span>
                                </label>
                            </div>
                            <div id="tuesday_schedule" class="flex-1 flex items-center gap-2">
                                <input type="time" id="tuesday_open" class="form-input" value="09:00">
                                <span>-</span>
                                <input type="time" id="tuesday_close" class="form-input" value="17:00">
                            </div>
                        </div>

                        <!-- Wednesday -->
                        <div class="flex items-center gap-3">
                            <div class="w-32">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="wednesday_enabled" class="mr-2" checked onchange="toggleDaySchedule('wednesday')">
                                    <span class="font-medium" data-translate="wednesday">Wednesday</span>
                                </label>
                            </div>
                            <div id="wednesday_schedule" class="flex-1 flex items-center gap-2">
                                <input type="time" id="wednesday_open" class="form-input" value="09:00">
                                <span>-</span>
                                <input type="time" id="wednesday_close" class="form-input" value="17:00">
                            </div>
                        </div>

                        <!-- Thursday -->
                        <div class="flex items-center gap-3">
                            <div class="w-32">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="thursday_enabled" class="mr-2" checked onchange="toggleDaySchedule('thursday')">
                                    <span class="font-medium" data-translate="thursday">Thursday</span>
                                </label>
                            </div>
                            <div id="thursday_schedule" class="flex-1 flex items-center gap-2">
                                <input type="time" id="thursday_open" class="form-input" value="09:00">
                                <span>-</span>
                                <input type="time" id="thursday_close" class="form-input" value="17:00">
                            </div>
                        </div>

                        <!-- Friday -->
                        <div class="flex items-center gap-3">
                            <div class="w-32">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="friday_enabled" class="mr-2" checked onchange="toggleDaySchedule('friday')">
                                    <span class="font-medium" data-translate="friday">Friday</span>
                                </label>
                            </div>
                            <div id="friday_schedule" class="flex-1 flex items-center gap-2">
                                <input type="time" id="friday_open" class="form-input" value="09:00">
                                <span>-</span>
                                <input type="time" id="friday_close" class="form-input" value="17:00">
                            </div>
                        </div>

                        <!-- Saturday -->
                        <div class="flex items-center gap-3">
                            <div class="w-32">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="saturday_enabled" class="mr-2" onchange="toggleDaySchedule('saturday')">
                                    <span class="font-medium" data-translate="saturday">Saturday</span>
                                </label>
                            </div>
                            <div id="saturday_schedule" class="flex-1 flex items-center gap-2" style="opacity: 0.5;">
                                <input type="time" id="saturday_open" class="form-input" value="09:00" disabled>
                                <span>-</span>
                                <input type="time" id="saturday_close" class="form-input" value="13:00" disabled>
                            </div>
                        </div>

                        <!-- Sunday -->
                        <div class="flex items-center gap-3">
                            <div class="w-32">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="sunday_enabled" class="mr-2" onchange="toggleDaySchedule('sunday')">
                                    <span class="font-medium" data-translate="sunday">Sunday</span>
                                </label>
                            </div>
                            <div id="sunday_schedule" class="flex-1 flex items-center gap-2" style="opacity: 0.5;">
                                <input type="time" id="sunday_open" class="form-input" value="09:00" disabled>
                                <span>-</span>
                                <input type="time" id="sunday_close" class="form-input" value="13:00" disabled>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCabinetSettings()"
                        data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save_settings">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal" id="userManagementModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="user_management">User Management</h2>
                <button class="modal-close" onclick="closeUserManagement()">&times;</button>
            </div>

            <div class="p-6">
                <!-- Add New User Section -->
                <div class="card p-4 mb-6">
                    <h3 class="font-semibold mb-4" data-translate="add_new_user">Add New User</h3>
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label" for="newUserName" data-translate="user_full_name">Full Name *</label>
                                <input type="text" id="newUserName" class="form-input" required placeholder="John Doe">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="newUserEmail" data-translate="user_email">Email *</label>
                                <input type="email" id="newUserEmail" class="form-input" required placeholder="user@example.com">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label" for="newUserUsername" data-translate="username">Username *</label>
                                <input type="text" id="newUserUsername" class="form-input" required placeholder="johndoe">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="newUserPassword" data-translate="password">Password *</label>
                                <input type="password" id="newUserPassword" class="form-input" required placeholder="••••••••">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label" for="newUserRole" data-translate="user_role">Role *</label>
                                <select id="newUserRole" class="form-input" required>
                                    <option value="">Select role...</option>
                                    <option value="doctor">Doctor</option>
                                    <option value="secretary">Secretary</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="newUserStatus" data-translate="user_status">Status *</label>
                                <select id="newUserStatus" class="form-input" required>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <!-- Permissions Section -->
                        <div class="form-group">
                            <label class="form-label font-semibold text-lg mb-3" data-translate="user_permissions">User Permissions</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <!-- Patients Permissions -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-sm text-gray-700" data-translate="patients_module">Patients Module</h4>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_view_patients" class="mr-2">
                                        <span class="text-sm" data-translate="perm_view_patients">View Patients</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_add_patients" class="mr-2">
                                        <span class="text-sm" data-translate="perm_add_patients">Add/Edit Patients</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_delete_patients" class="mr-2">
                                        <span class="text-sm" data-translate="perm_delete_patients">Delete Patients</span>
                                    </label>
                                </div>

                                <!-- Appointments Permissions -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-sm text-gray-700" data-translate="appointments_module">Appointments Module</h4>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_view_appointments" class="mr-2">
                                        <span class="text-sm" data-translate="perm_view_appointments">View Appointments</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_add_appointments" class="mr-2">
                                        <span class="text-sm" data-translate="perm_add_appointments">Add/Edit Appointments</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_delete_appointments" class="mr-2">
                                        <span class="text-sm" data-translate="perm_delete_appointments">Delete Appointments</span>
                                    </label>
                                </div>

                                <!-- Billing Permissions -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-sm text-gray-700" data-translate="billing_module">Billing Module</h4>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_view_bills" class="mr-2">
                                        <span class="text-sm" data-translate="perm_view_bills">View Bills</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_create_bills" class="mr-2">
                                        <span class="text-sm" data-translate="perm_create_bills">Create Bills</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_manage_bills" class="mr-2">
                                        <span class="text-sm" data-translate="perm_manage_bills">Manage Bills</span>
                                    </label>
                                </div>

                                <!-- Consultations Permissions -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-sm text-gray-700" data-translate="consultations_module">Consultations Module</h4>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_view_consultations" class="mr-2">
                                        <span class="text-sm" data-translate="perm_view_consultations">View Consultations</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_add_consultations" class="mr-2">
                                        <span class="text-sm" data-translate="perm_add_consultations">Add/Edit Consultations</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_delete_consultations" class="mr-2">
                                        <span class="text-sm" data-translate="perm_delete_consultations">Delete Consultations</span>
                                    </label>
                                </div>

                                <!-- Reports Permissions -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-sm text-gray-700" data-translate="reports_module">Reports Module</h4>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_view_reports" class="mr-2">
                                        <span class="text-sm" data-translate="perm_view_reports">View Reports</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_export_reports" class="mr-2">
                                        <span class="text-sm" data-translate="perm_export_reports">Export Reports</span>
                                    </label>
                                </div>

                                <!-- Settings Permissions -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-sm text-gray-700" data-translate="settings_module">Settings Module</h4>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_access_settings" class="mr-2">
                                        <span class="text-sm" data-translate="perm_access_settings">Access Settings</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="newPerm_manage_users" class="mr-2">
                                        <span class="text-sm" data-translate="perm_manage_users">Manage Users</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary">
                                <svg class="icon-sm mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                <span data-translate="add_user">Add User</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Existing Users List -->
                <div class="card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold" data-translate="existing_users">Existing Users</h3>
                        <div class="flex items-center gap-4">
                            <div class="text-sm text-gray-600">
                                <span data-translate="total_users">Total Users:</span>
                                <span id="totalUsersCount" class="font-semibold ml-1">0</span>
                            </div>
                            <button onclick="exportUserCredentials()" class="btn btn-outline btn-sm" data-translate="export_credentials">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export Credentials
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <input type="text" id="userSearch" class="form-input" 
                            placeholder="Search users by name, email, or username..."
                            onkeyup="searchUsers()" data-translate-placeholder="search_users">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="user_full_name">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="username">Username</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="user_email">Email</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="user_role">Role</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="user_status">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeUserManagement()"
                    data-translate="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="editUserModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="edit_user">Edit User</h2>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>

            <form id="editUserForm" class="p-6 space-y-4">
                <input type="hidden" id="editUserId">
                
                <div class="form-group">
                    <label class="form-label" for="editUserName" data-translate="user_full_name">Full Name *</label>
                    <input type="text" id="editUserName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editUserEmail" data-translate="user_email">Email *</label>
                    <input type="email" id="editUserEmail" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editUserUsername" data-translate="username">Username *</label>
                    <input type="text" id="editUserUsername" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editUserPassword" data-translate="new_password">New Password</label>
                    <input type="password" id="editUserPassword" class="form-input" placeholder="Leave empty to keep current password">
                    <p class="text-sm text-gray-500 mt-1" data-translate="password_hint">Leave empty to keep current password</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editUserRole" data-translate="user_role">Role *</label>
                    <select id="editUserRole" class="form-input" required>
                        <option value="doctor">Doctor</option>
                        <option value="secretary">Secretary</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editUserStatus" data-translate="user_status">Status *</label>
                    <select id="editUserStatus" class="form-input" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>

                <!-- Permissions Section -->
                <div class="form-group">
                    <label class="form-label font-semibold text-lg mb-3" data-translate="user_permissions">User Permissions</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <!-- Patients Permissions -->
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm text-gray-700" data-translate="patients_module">Patients Module</h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_view_patients" class="mr-2">
                                <span class="text-sm" data-translate="perm_view_patients">View Patients</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_add_patients" class="mr-2">
                                <span class="text-sm" data-translate="perm_add_patients">Add/Edit Patients</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_delete_patients" class="mr-2">
                                <span class="text-sm" data-translate="perm_delete_patients">Delete Patients</span>
                            </label>
                        </div>

                        <!-- Appointments Permissions -->
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm text-gray-700" data-translate="appointments_module">Appointments Module</h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_view_appointments" class="mr-2">
                                <span class="text-sm" data-translate="perm_view_appointments">View Appointments</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_add_appointments" class="mr-2">
                                <span class="text-sm" data-translate="perm_add_appointments">Add/Edit Appointments</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_delete_appointments" class="mr-2">
                                <span class="text-sm" data-translate="perm_delete_appointments">Delete Appointments</span>
                            </label>
                        </div>

                        <!-- Billing Permissions -->
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm text-gray-700" data-translate="billing_module">Billing Module</h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_view_bills" class="mr-2">
                                <span class="text-sm" data-translate="perm_view_bills">View Bills</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_create_bills" class="mr-2">
                                <span class="text-sm" data-translate="perm_create_bills">Create Bills</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_manage_bills" class="mr-2">
                                <span class="text-sm" data-translate="perm_manage_bills">Manage Bills</span>
                            </label>
                        </div>

                        <!-- Expenses Permissions -->
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm text-gray-700" data-translate="expenses_module">Expenses Module</h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_view_expenses" class="mr-2">
                                <span class="text-sm" data-translate="perm_view_expenses">View Expenses</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_manage_expenses" class="mr-2">
                                <span class="text-sm" data-translate="perm_manage_expenses">Manage Expenses</span>
                            </label>
                        </div>

                        <!-- Consultations Permissions -->
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm text-gray-700" data-translate="consultations_module">Consultations Module</h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_view_consultations" class="mr-2">
                                <span class="text-sm" data-translate="perm_view_consultations">View Consultations</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_add_consultations" class="mr-2">
                                <span class="text-sm" data-translate="perm_add_consultations">Add/Edit Consultations</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_delete_consultations" class="mr-2">
                                <span class="text-sm" data-translate="perm_delete_consultations">Delete Consultations</span>
                            </label>
                        </div>

                        <!-- Reports Permissions -->
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm text-gray-700" data-translate="reports_module">Reports Module</h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_view_reports" class="mr-2">
                                <span class="text-sm" data-translate="perm_view_reports">View Reports</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_export_reports" class="mr-2">
                                <span class="text-sm" data-translate="perm_export_reports">Export Reports</span>
                            </label>
                        </div>

                        <!-- Settings Permissions -->
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm text-gray-700" data-translate="settings_module">Settings Module</h4>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_access_settings" class="mr-2">
                                <span class="text-sm" data-translate="perm_access_settings">Access Settings</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="editPerm_manage_users" class="mr-2">
                                <span class="text-sm" data-translate="perm_manage_users">Manage Users</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()"
                        data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="save_changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Doctor Profit Reports Modal -->
    <div class="modal" id="reportsModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="profit_reports">Profit Reports</h2>
                <button class="modal-close" onclick="closeReportsModal()">&times;</button>
            </div>

            <!-- Tabs for Daily, Weekly, Monthly -->
            <div class="flex gap-4 mb-6">
                <button id="dailyReportTab" class="btn btn-primary" onclick="switchReportTab('daily')"
                    data-translate="daily_report">Daily Report</button>
                <button id="weeklyReportTab" class="btn btn-secondary" onclick="switchReportTab('weekly')"
                    data-translate="weekly_report">Weekly Report</button>
                <button id="monthlyReportTab" class="btn btn-secondary" onclick="switchReportTab('monthly')"
                    data-translate="monthly_report">Monthly Report</button>
                <button id="unpaidPatientsTab" class="btn btn-secondary" onclick="switchReportTab('unpaidPatients')"
                    data-translate="unpaid_patients">Patient impayé</button>
                <button id="inProgressPaymentsTab" class="btn btn-secondary" onclick="switchReportTab('inProgressPayments')"
                    data-translate="in_progress_payments">Encours paiement</button>
            </div>

            <div class="modal-body">
                <div id="dailyReportContent">
                    <div class="mb-4">
                        <label class="form-label" data-translate="select_date">Select Date:</label>
                        <input type="date" id="dailyReportDate" class="form-input" style="max-width: 200px;" 
                            onchange="renderDailyReport()">
                    </div>
                    <div id="dailyReportContainer"></div>
                </div>

                <div id="weeklyReportContent" style="display: none;">
                    <div class="mb-4">
                        <label class="form-label" data-translate="select_week">Select Week Start Date:</label>
                        <input type="date" id="weeklyReportDate" class="form-input" style="max-width: 200px;" 
                            onchange="renderWeeklyReport()">
                    </div>
                    <div id="weeklyReportContainer"></div>
                </div>

                <div id="monthlyReportContent" style="display: none;">
                    <div class="mb-4 flex gap-4">
                        <div>
                            <label class="form-label" data-translate="select_month">Select Month:</label>
                            <select id="monthlyReportMonth" class="form-input" onchange="renderMonthlyReport()">
                                <option value="0" data-translate="january">January</option>
                                <option value="1" data-translate="february">February</option>
                                <option value="2" data-translate="march">March</option>
                                <option value="3" data-translate="april">April</option>
                                <option value="4" data-translate="may">May</option>
                                <option value="5" data-translate="june">June</option>
                                <option value="6" data-translate="july">July</option>
                                <option value="7" data-translate="august">August</option>
                                <option value="8" data-translate="september">September</option>
                                <option value="9" data-translate="october">October</option>
                                <option value="10" data-translate="november">November</option>
                                <option value="11" data-translate="december">December</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label" data-translate="select_year">Select Year:</label>
                            <select id="monthlyReportYear" class="form-input" onchange="renderMonthlyReport()">
                                <!-- Years will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div id="monthlyReportContainer"></div>
                </div>

                <div id="unpaidPatientsContent" style="display: none;">
                    <div class="mb-4 flex gap-4">
                        <div>
                            <label class="form-label" data-translate="select_month">Select Month:</label>
                            <select id="unpaidPatientsMonth" class="form-input" onchange="renderUnpaidPatientsReport()">
                                <option value="0" data-translate="january">January</option>
                                <option value="1" data-translate="february">February</option>
                                <option value="2" data-translate="march">March</option>
                                <option value="3" data-translate="april">April</option>
                                <option value="4" data-translate="may">May</option>
                                <option value="5" data-translate="june">June</option>
                                <option value="6" data-translate="july">July</option>
                                <option value="7" data-translate="august">August</option>
                                <option value="8" data-translate="september">September</option>
                                <option value="9" data-translate="october">October</option>
                                <option value="10" data-translate="november">November</option>
                                <option value="11" data-translate="december">December</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label" data-translate="select_year">Select Year:</label>
                            <select id="unpaidPatientsYear" class="form-input" onchange="renderUnpaidPatientsReport()">
                                <!-- Years will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div id="unpaidPatientsContainer"></div>
                </div>

                <div id="inProgressPaymentsContent" style="display: none;">
                    <div class="mb-4 flex gap-4">
                        <div>
                            <label class="form-label" data-translate="select_month">Select Month:</label>
                            <select id="inProgressPaymentsMonth" class="form-input" onchange="renderInProgressPaymentsReport()">
                                <option value="0" data-translate="january">January</option>
                                <option value="1" data-translate="february">February</option>
                                <option value="2" data-translate="march">March</option>
                                <option value="3" data-translate="april">April</option>
                                <option value="4" data-translate="may">May</option>
                                <option value="5" data-translate="june">June</option>
                                <option value="6" data-translate="july">July</option>
                                <option value="7" data-translate="august">August</option>
                                <option value="8" data-translate="september">September</option>
                                <option value="9" data-translate="october">October</option>
                                <option value="10" data-translate="november">November</option>
                                <option value="11" data-translate="december">December</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label" data-translate="select_year">Select Year:</label>
                            <select id="inProgressPaymentsYear" class="form-input" onchange="renderInProgressPaymentsReport()">
                                <!-- Years will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div id="inProgressPaymentsContainer"></div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeReportsModal()" data-translate="close">Close</button>
                <button type="button" class="btn btn-primary" onclick="printReport()" data-translate="print_report">Print Report</button>
                <button type="button" class="btn btn-primary" onclick="exportReport()" data-translate="export_report">Export Report</button>
                <button type="button" class="btn btn-outline" onclick="exportFullBackupForCurrentMonth()" data-translate="export_full_backup" data-permission="export_reports">Export all data</button>
            </div>
        </div>
    </div>

    <div class="p-4" style="margin-top: 4rem;">
        <div class="max-w-7xl mx-auto">
            <div class="mb-6 mt-8">
                <div class="flex flex-col xl:flex-row xl:items-center xl:justify-between gap-4">
                    <div class="flex-1" id="dailySummaryContainer"></div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-outline" onclick="goToPreviousDay()">
                            <svg class="icon mr-2" viewBox="0 0 24 24">
                                <path d="m15 18-6-6 6-6" />
                            </svg>
                            <span data-translate="previous">Previous</span>
                        </button>
                        <button class="btn btn-outline" onclick="goToToday()">
                            <span data-translate="today">Today</span>
                        </button>
                        <button class="btn btn-outline" onclick="goToNextDay()">
                            <span data-translate="next">Next</span>
                            <svg class="icon ml-2" viewBox="0 0 24 24">
                                <path d="m9 18 6-6-6-6" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Daily Summary Badges (Fallback if JS not run) -->
                <div class="lg:col-span-4 hidden" id="dailySummaryFallback"></div>

                <!-- Calendar Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Waiting Room -->
                    <div class="card p-6 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <h3 class="text-lg font-semibold" data-translate="waiting_room">WAITING ROOM</h3>
                            </div>
                            <span id="waitingRoomCount" class="badge bg-blue-100 text-blue-800">0</span>
                        </div>
                        <div id="waitingRoomList" class="space-y-2">
                            <p class="text-gray-500 text-center py-4" data-translate="no_patients_waiting">No patients waiting</p>
                        </div>
                    </div>

                    <!-- Calendar -->
                    <div class="card p-4 mt-4">
                        <div class="flex items-center gap-2 mb-4">
                            <svg class="icon-lg" viewBox="0 0 24 24">
                                <path d="M8 2v4" />
                                <path d="M16 2v4" />
                                <rect width="18" height="18" x="3" y="4" rx="2" />
                                <path d="M3 10h18" />
                            </svg>
                            <h3 class="text-lg font-semibold" data-translate="calendar">Calendar</h3>
                        </div>
                        <div class="calendar">
                            <div class="calendar-header">
                                <button class="btn btn-outline p-1" onclick="previousMonth()">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <path d="m15 18-6-6 6-6" />
                                    </svg>
                                </button>
                                <h4 id="currentMonthYear" class="font-medium"></h4>
                                <button class="btn btn-outline p-1" onclick="nextMonth()">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <path d="m9 18 6-6-6-6" />
                                    </svg>
                                </button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid">
                                <!-- Calendar days will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Cabinet Cash Card -->
                    <div id="cabinetCashDisplay" class="card p-6 mt-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex flex-col">
                                <div class="text-sm text-gray-500 mb-1" data-translate="cabinet_cash">Cabinet Cash</div>
                                <div class="text-2xl font-bold text-blue-600 mb-1">0.00 TND</div>
                                <div class="text-sm text-gray-400" data-translate="bills_today">bills today</div>
                            </div>
                            <svg class="w-12 h-12 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600" data-translate="cash_entry">Cash Entry</span>
                            </div>
                            <div class="font-semibold text-gray-800">0.00 TND</div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600" data-translate="expenses">Expenses</span>
                            </div>
                            <div class="font-semibold text-gray-800">0.00 TND</div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card p-6 mt-4">
                        <h3 class="text-lg font-semibold mb-4" data-translate="today_summary">Today's Summary</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span data-translate="total_appointments">Total Appointments</span>
                                <span id="totalAppointments" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="pre_validation">Pre-validation</span>
                                <span id="preValidationAppointments" class="font-semibold text-orange-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="validated">Validated</span>
                                <span id="confirmedAppointments" class="font-semibold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="cancelled">Cancelled</span>
                                <span id="cancelledAppointments" class="font-semibold text-red-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Agenda View -->
                <div class="lg:col-span-3">
                    <div id="dailyAgenda">
                        <!-- Daily agenda content will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clinical Examination Modal -->
    <div class="modal" id="clinicalExamModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="clinical_examination">Clinical examinations</h2>
                <button class="modal-close" onclick="closeClinicalExamModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-gray-600 mb-4" data-translate="enter_clinical_examination">Document clinical examination findings.</p>
                <textarea id="clinicalExamText" class="form-input form-textarea" rows="8" placeholder="Enter clinical examination findings..."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeClinicalExamModal()" data-translate="close">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveClinicalExam()" data-translate="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Medical Diagnosis Modal -->
    <div class="modal" id="diagnosisModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="medical_diagnosis">Medical diagnoses</h2>
                <button class="modal-close" onclick="closeDiagnosisModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-gray-600 mb-4" data-translate="enter_medical_diagnosis">Document the medical diagnosis.</p>
                <textarea id="diagnosisText" class="form-input form-textarea" rows="6" placeholder="Enter diagnosis..."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDiagnosisModal()" data-translate="close">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveDiagnosis()" data-translate="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Notes & Observations Modal -->
    <div class="modal" id="notesObservationsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="notes_observations">Notes and observations</h2>
                <button class="modal-close" onclick="closeNotesObservationsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-gray-600 mb-4" data-translate="enter_notes_observations">Add supplementary notes and observations.</p>
                <textarea id="notesObservationsText" class="form-input form-textarea" rows="6" placeholder="Enter notes and observations..."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeNotesObservationsModal()" data-translate="close">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveNotesObservations()" data-translate="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Consultation Detail Modal -->
    <div class="modal" id="consultationDetailModal">
        <div class="modal-content" id="consultationDetailModalContent" style="max-width: 800px;" role="dialog" aria-modal="true" tabindex="-1">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="consultation_details">Consultation Details</h2>
                <button class="modal-close" onclick="closeConsultationDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="consultationDetailContent" class="space-y-4">
                    <!-- Consultation details will be loaded here -->
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeConsultationDetail()" data-translate="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Doctor Dashboard Modal -->
    <div class="modal" id="doctorDashboardModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="doctor_dashboard">Doctor Dashboard</h2>
                <button class="modal-close" onclick="closeDoctorDashboard()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Today's Appointments -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="today_appointments">Today's Appointments</h3>
                            <span id="appointmentCount" class="badge badge-primary">0</span>
                        </div>
                        <div class="card-body">
                            <div id="todayAppointmentsList" class="space-y-3">
                                <!-- Appointments will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Today's Consultations -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold text-gray-900" data-translate="today_consultations">Today's Consultations</h3>
                            <span id="consultationCount" class="badge badge-primary">0</span>
                        </div>
                        <div class="card-body">
                            <div id="todayConsultationsList" class="space-y-3">
                                <!-- Consultations will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenses Modal -->
    <div class="modal" id="expensesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" data-translate="expenses">Expenses</h2>
                <button class="modal-close" onclick="closeExpensesModal()">&times;</button>
            </div>

            <div class="flex gap-4 mb-6">
                <button id="addExpenseTab" class="btn btn-primary" onclick="switchExpenseTab('add')" data-translate="add_expense">Add Expense</button>
                <button id="viewExpensesTab" class="btn btn-secondary" onclick="switchExpenseTab('view')" data-translate="view_expenses">View Expenses</button>
            </div>

            <!-- Add Expense Form -->
            <div id="addExpenseContent" class="expense-tab-content">
                <form id="expenseForm">
                    <div class="form-group">
                        <label class="form-label" for="expenseDescription" data-translate="description">Description *</label>
                        <textarea id="expenseDescription" class="form-input form-textarea" rows="3" placeholder="Enter expense description..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="expenseAmount" data-translate="amount">Amount (TND) *</label>
                        <input type="number" id="expenseAmount" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeExpensesModal()" data-translate="cancel">Cancel</button>
                        <button type="submit" class="btn btn-primary" data-translate="add_expense">Add Expense</button>
                    </div>
                </form>
            </div>

            <!-- View Expenses List -->
            <div id="viewExpensesContent" class="expense-tab-content" style="display: none;">
                <div class="mb-4">
                    <input type="text" id="expenseSearch" class="form-input" placeholder="Search expenses..." onkeyup="filterExpenses()">
                </div>
                <div class="expense-list" id="expenseList">
                    <!-- Expenses will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="i18n/i18n.js"></script>
    <script src="scripts/translation.js"></script>
    <script src="scripts/expense_management.js"></script>
    <script src="scripts/logout.js"></script>
    <script src="scripts/medicalCertificate.js"></script>
    <script src="scripts/medicalPrescription.js"></script>
    <script src="scripts/consultation.js"></script>
    <script src="scripts/app_script.js"></script>
    <script src="scripts/payement.js"></script>
    <script src="scripts/partially_paid.js"></script>
    <script>
        // Verify and ensure showDoctorDashboard is available
        (function() {
            const ensureDashboard = function(){
                if (typeof window.showDoctorDashboard !== 'function') {
                    console.warn('showDoctorDashboard not available, installing safe fallback');
                    window.showDoctorDashboard = function() {
                        // Open the modal directly as a graceful fallback
                        const modal = document.getElementById('doctorDashboardModal');
                        if (modal) {
                            modal.classList.add('active');
                            // Load data if functions exist
                            if (typeof window.loadTodayAppointments === 'function') window.loadTodayAppointments();
                            if (typeof window.loadTodayConsultations === 'function') window.loadTodayConsultations();
                            if (typeof window.updateModalTranslations === 'function') window.updateModalTranslations();
                        } else {
                            console.error('Doctor dashboard modal element not found');
                        }
                    };
                } else {
                    console.log('showDoctorDashboard is available');
                }
            };
            // Run after a short delay and again on window load to avoid race conditions
            setTimeout(ensureDashboard, 100);
            window.addEventListener('load', ensureDashboard);
        })();

        // Verify and ensure showBillingOrReadyBills is available
        (function() {
            const ensureBilling = function(){
                if (typeof window.showBillingOrReadyBills !== 'function') {
                    console.warn('showBillingOrReadyBills not available, installing safe fallback');
                    window.showBillingOrReadyBills = function() {
                        // Graceful fallback: open main billing modal if available
                        if (typeof window.showBillingModal === 'function') {
                            window.showBillingModal();
                        } else {
                            alert('Billing feature is not available.');
                        }
                    };
                } else {
                    console.log('showBillingOrReadyBills is available');
                }
            };
            // Run after a short delay and again on window load to avoid race conditions
            setTimeout(ensureBilling, 100);
            window.addEventListener('load', ensureBilling);
        })();
    </script>
    <script>
        // Ensure consultation modal helpers exist to prevent onclick ReferenceError
        (function(){
            const ensureConsultationHelpers = function(){
                // Ensure showConsultationModal exists
                if (typeof window.showConsultationModal !== 'function') {
                    window.showConsultationModal = function() {
                        const modal = document.getElementById('consultationModal');
                        if (modal) {
                            modal.classList.add('active');
                        } else {
                            console.warn('Consultation modal element not found');
                        }
                    };
                }
                
                // Ensure loadConsultationPatientDetails exists
                if (typeof window.loadConsultationPatientDetails !== 'function') {
                    window.loadConsultationPatientDetails = function() {
                        console.warn('loadConsultationPatientDetails not yet loaded');
                    };
                }
                
                // Ensure startConsultation exists
                if (typeof window.startConsultation !== 'function') {
                    console.warn('startConsultation not available, installing safe fallback');
                    window.startConsultation = function(appointmentId, patientName, patientId){
                        // Graceful fallback: open consultation modal and prefill name
                        if (typeof window.showConsultationModal === 'function') {
                            window.showConsultationModal();
                            const name = (patientName||'').trim();
                            const patientInput = document.getElementById('consultPatient'); 
                            if (patientInput) patientInput.value = name;
                            const patientIdInput = document.getElementById('consultPatientId'); 
                            if (patientIdInput) patientIdInput.value = patientId || '';
                            // Attempt to load details if we have an ID
                            if ((patientId||'') && typeof window.loadConsultationPatientDetails === 'function') {
                                setTimeout(()=>window.loadConsultationPatientDetails(), 150);
                            }
                        } else {
                            console.error('Consultation modal helpers not loaded');
                        }
                    };
                }
            };
            // Install immediately to prevent early clicks from failing
            ensureConsultationHelpers();
            // Also ensure after full load
            window.addEventListener('load', ensureConsultationHelpers);
        })();
    </script>
    <script>
        // Initialize i18n system
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any conflicting language settings
            localStorage.removeItem('selectedLanguage');
            localStorage.removeItem('bill_descriptions');
            
            if (window.I18n) {
                // Force French as default to avoid browser language detection
                const storedLang = localStorage.getItem('app_lang');
                if (!storedLang) {
                    localStorage.setItem('app_lang', 'fr');
                }
                
                window.I18n.initI18n({ lang: storedLang || 'fr' });
                
                // Override setLanguage to refresh dashboard
                const originalSetLanguage = window.I18n.setLanguage;
                window.I18n.setLanguage = async function(lang) {
                    console.log('Switching to language:', lang);
                    await originalSetLanguage.call(this, lang);
                    // Refresh dashboard after language change
                    if (typeof renderDailyAgenda === 'function') {
                        renderDailyAgenda();
                    }
                    // Refresh calendar after language change
                    if (typeof renderCalendar === 'function') {
                        renderCalendar();
                    }
                    // Update language radio buttons
                    updateLanguageRadioButtons(lang);
                    // Refresh doctor dashboard if it's open
                    const dashboardModal = document.getElementById('doctorDashboardModal');
                    if (dashboardModal && dashboardModal.classList.contains('active')) {
                        if (typeof window.loadTodayAppointments === 'function') window.loadTodayAppointments();
                        if (typeof window.loadTodayConsultations === 'function') window.loadTodayConsultations();
                    }
                };
                
                // Set initial language radio button
                const currentLang = localStorage.getItem('app_lang') || 'fr';
                updateLanguageRadioButtons(currentLang);
            }
        });

        // Function to update language radio buttons
        function updateLanguageRadioButtons(lang) {
            console.log('Updating radio buttons for language:', lang);
            const radioButtons = document.querySelectorAll('input[name="language"]');
            radioButtons.forEach(radio => {
                const isChecked = radio.value === lang;
                radio.checked = isChecked;
                console.log(`Radio button ${radio.value}: ${isChecked ? 'checked' : 'unchecked'}`);
            });
        }


        // Override the showLanguageSettings function to ensure proper radio button sync
        window.addEventListener('DOMContentLoaded', function() {
            // Override the showLanguageSettings function after it's defined
            setTimeout(() => {
                if (window.showLanguageSettings) {
                    const originalShowLanguageSettings = window.showLanguageSettings;
                    window.showLanguageSettings = function() {
                        originalShowLanguageSettings();
                        // Ensure radio buttons are properly synced
                        const currentLang = localStorage.getItem('app_lang') || 'fr';
                        updateLanguageRadioButtons(currentLang);
                    };
                }
            }, 1000);
        });

        // Function to switch language using i18n system
        function switchToLanguage(lang) {
            console.log('switchToLanguage called with:', lang);
            console.log('I18n available:', !!window.I18n);
            console.log('setLanguage available:', !!(window.I18n && window.I18n.setLanguage));
            
            // Clear any conflicting legacy language settings
            localStorage.removeItem('selectedLanguage');
            
            if (window.I18n && window.I18n.setLanguage) {
                console.log('Using i18n system');
                window.I18n.setLanguage(lang).then(() => {
                    console.log('Language switched successfully to:', lang);
                    // Update radio buttons after successful language change
                    updateLanguageRadioButtons(lang);
                }).catch(error => {
                    console.error('Error switching language:', error);
                });
            } else {
                console.log('Using legacy system');
                // Fallback to legacy system
                if (typeof changeLanguage === 'function') {
                    changeLanguage(lang);
                }
            }
            
            // Close the language settings modal after a short delay
            setTimeout(() => {
                if (typeof closeLanguageSettings === 'function') {
                    closeLanguageSettings();
                }
            }, 800);
        }
    </script>
   

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <svg class="footer-logo-emblem" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Sailboat and waves -->
                    <path d="M14 4 L12 11 L16 11 Z" fill="#d4af37" stroke="#b8941f" stroke-width="0.3" />
                    <path d="M14 4 L13 11 L15 11 Z" fill="#f4d03f" opacity="0.8" />
                    <path d="M9 14 Q12 12 14 14 Q16 12 19 14 Q16 16 14 14 Q12 16 9 14 Z" fill="#d4af37" stroke="#b8941f"
                        stroke-width="0.3" />
                    <path d="M7 17 Q12 15 14 17 Q16 15 21 17 Q16 19 14 17 Q12 19 7 17 Z" fill="#d4af37" stroke="#b8941f"
                        stroke-width="0.3" />
                    <path d="M5 20 Q12 18 14 20 Q16 18 23 20 Q16 22 14 20 Q12 22 5 20 Z" fill="#d4af37" stroke="#b8941f"
                        stroke-width="0.3" />
                </svg>
                <div class="footer-logo-text">
                    <div class="footer-logo-company">CERCINATECK</div>
                    <div class="footer-logo-tagline">VOTRE PARTENAIRE POUR UNE GESTION OPTIMALE</div>
                </div>
            </div>
            <div class="footer-separator"></div>
            <div class="footer-copyright">© 2024 CERCINATECK. <span data-translate="all_rights_reserved">Tous droits réservés.</span></div>
        </div>
    </footer>
</body>

</html>