// Translation module (global)
// Initializes currentLanguage from app_lang (preferred) or selectedLanguage
(function(){
  // Global current language synced with localStorage
  var getLang = function(){
    return localStorage.getItem('app_lang') || localStorage.getItem('selectedLanguage') || 'fr';
  };
  var setLang = function(lang){
    localStorage.setItem('app_lang', lang);
    localStorage.setItem('selectedLanguage', lang);
    // Keep both the local and global language indicators in sync
    currentLanguage = lang;
    window.currentLanguage = lang;
  };
  
  // Expose currentLanguage as a global var (and window prop)
  window.currentLanguage = window.currentLanguage || getLang();
  var currentLanguage = window.currentLanguage;

  // Translations moved from app_script.js (Arabic removed)
  // Keep var so both `translations` and `window.translations` work
  var translations = window.translations || {
    en: {
      dashboard: 'Dashboard',
      add_appointment: 'Add Appointment',
      patients: 'Patients',
      billing: 'Billing',
      payment_tab: 'Payment',
      reports: 'Reports',
      consultation: 'Consultation',
      settings: 'Settings',
      language_settings: 'Language Settings',
      select_language: 'Select Language:',
      close: 'Close',
      manage_language: 'Change application language',
      bill_descriptions: 'Bill Descriptions',
      manage_bill_descriptions: 'Manage billing service items',
      add_new_description: 'Add New Service',
      service_name: 'Service Name',
      default_price: 'Default Price (TND)',
      add_service: 'Add Service',
      existing_services: 'Existing Services',
      search_services: 'Search services...',
      edit_service: 'Edit Service',
      save_changes: 'Save Changes',
      delete_service: 'Delete Service',
      confirm_delete_service: 'Are you sure you want to delete this service?',
      service_added: 'Service added successfully!',
      service_updated: 'Service updated successfully!',
      service_deleted: 'Service deleted successfully!',
      cabinet_settings: 'Cabinet Settings',
      manage_cabinet_info: 'Manage cabinet name, logo & schedule',
      cabinet_information: 'Cabinet Information',
      cabinet_name: 'Cabinet Name',
      cabinet_address: 'Cabinet Address',
      cabinet_phone: 'Cabinet Phone',
      cabinet_logo: 'Cabinet Logo',
      upload_logo: 'Upload Logo',
      remove_logo: 'Remove Logo',
      logo_recommendation: 'Recommended: Square image, max 2MB',
      cabinet_timetable: 'Working Hours / Timetable',
      monday: 'Monday',
      tuesday: 'Tuesday',
      wednesday: 'Wednesday',
      thursday: 'Thursday',
      friday: 'Friday',
      saturday: 'Saturday',
      sunday: 'Sunday',
      save_settings: 'Save Settings',
      settings_saved: 'Settings saved successfully!',
      logo_too_large: 'Image is too large. Maximum size is 2MB.',
      invalid_image: 'Invalid image file. Please upload a valid image.',
      user_management: 'User Management',
      manage_users_access: 'Manage users and their access',
      add_new_user: 'Add New User',
      existing_users: 'Existing Users',
      total_users: 'Total Users',
      search_users: 'Search users by name, email, or username...',
      user_full_name: 'Full Name',
      user_email: 'Email',
      username: 'Username',
      password: 'Password',
      new_password: 'New Password',
      password_hint: 'Leave empty to keep current password',
      user_role: 'Role',
      user_status: 'Status',
      actions: 'Actions',
      add_user: 'Add User',
      edit_user: 'Edit User',
      delete_user: 'Delete User',
      confirm_delete_user: 'Are you sure you want to delete this user?',
      user_added: 'User added successfully!',
      user_updated: 'User updated successfully!',
      user_deleted: 'User deleted successfully!',
      username_exists: 'Username already exists!',
      email_exists: 'Email already exists!',
      user_permissions: 'User Permissions',
      patients_module: 'Patients Module',
      perm_view_patients: 'View Patients',
      perm_add_patients: 'Add/Edit Patients',
      perm_delete_patients: 'Delete Patients',
      appointments_module: 'Appointments Module',
      perm_view_appointments: 'View Appointments',
      perm_add_appointments: 'Add/Edit Appointments',
      perm_delete_appointments: 'Delete Appointments',
      billing_module: 'Billing Module',
      perm_view_bills: 'View Bills',
      perm_create_bills: 'Create Bills',
      perm_manage_bills: 'Manage Bills',
      consultations_module: 'Consultations Module',
      perm_view_consultations: 'View Consultations',
      perm_add_consultations: 'Add/Edit Consultations',
      perm_delete_consultations: 'Delete Consultations',
      reports_module: 'Reports Module',
      perm_view_reports: 'View Reports',
      perm_export_reports: 'Export Reports',
      settings_module: 'Settings Module',
      perm_access_settings: 'Access Settings',
      perm_manage_users: 'Manage Users',
      expenses_module: 'Expenses Module',
      perm_view_expenses: 'View Expenses',
      perm_manage_expenses: 'Manage Expenses',
      secretary_agenda: 'Secretary Agenda',
      manage_appointments: 'Manage daily appointments and schedule',
      cancel: 'Cancel',
      save: 'Save',
      edit: 'Edit',
      delete: 'Delete',
      add: 'Add',
      create: 'Create',
      secretary: 'Secretary',
      patient_file_number: 'Patient File Number',
      file_number: 'File Number',
      cin_passport: 'CIN or Passeport *',
      add_new_appointment: 'Add New Appointment',
      patient_management: 'Patient Management',
      edit_patient: 'Edit Patient',
      create_patient_bill: 'Create Patient Bill',
      add_new_patient: 'Add New Patient',
      view_all_patients: 'View All Patients',
      add_patient: 'Add Patient',
      update_patient: 'Update Patient',
      create_bill: 'Create Bill',
      test_print: 'Test Print',
      select_patient: 'Select Patient *',
      full_name: 'Full Name *',
      email_address: 'Email Address',
      phone_number: 'Phone Number *',
      appointment_date: 'Appointment Date',
      appointment_time: 'Appointment Time',
      appointment_type: 'Appointment Type',
      doctor_name: 'Doctor Name *',
      additional_notes: 'Additional Notes',
      date_of_birth: 'Date of Birth *',
      gender: 'Gender',
      address: 'Address',
      medical_history: 'Medical History / Notes',
      medical_files: 'Medical Files',
      bill_date: 'Bill Date',
      due_date: 'Due Date',
      bill_items: 'Bill Items',
      description: 'Description',
      quantity: 'Quantité',
      price: 'Prix (TND)',
      notes: 'Notes',
      remove_item: 'Remove Item',
      add_item: 'Add Item',
      new_consultation: 'New Consultation',
      patient_info: 'Patient Info',
      name: 'Name',
      phone: 'Phone',
      age_gender: 'Age/Gender',
      height_cm: 'Height (cm)',
      weight_kg: 'Weight (kg)',
      bmi: 'IMC (BMI)',
      temperature_c: 'Temperature (°C)',
      heart_rate_bpm: 'Heart Rate (bpm)',
      blood_sugar_mgdl: 'Blood Sugar (mg/dL)',
      blood_pressure_mmhg: 'Blood Pressure (mmHg)',
      vital_notes: 'Vital Notes',
      reason: 'Reason for Visit',
      diagnosis: 'Diagnosis',
      clinical_examination: 'Clinical Examination',
      clinical_notes: 'Clinical Note',
      prescription: 'Prescription',
      consultation_act: 'Consultation Act',
      consultation_amount: 'Consultation Amount',
      payment_status: 'Payment Status',
      paid_status: 'Paid',
      partially_paid_status: 'Partially Paid',
      unpaid_status: 'Unpaid',
      unpaid_patients: 'Unpaid Patients',
      in_progress_payments: 'Patients with Payments in Progress',
      loading_unpaid_patients: 'Loading unpaid patients...',
      loading_in_progress_payments: 'Loading patients with payments in progress...',
      partial_payment_progress: 'Payment progress',
      add_partial_payment: 'Add payment',
      enter_partial_payment_amount: 'Enter first payment amount (TND):',
      enter_additional_partial_payment_amount: 'Enter additional payment amount (TND):',
      invalid_partial_payment_amount: 'Please enter a valid amount greater than 0.',
      partial_payment_exceeds_total: 'Partial payment cannot exceed the total consultation amount.',
      paying_patient: 'Paying Patient',
      non_paying_patient: 'Non-Paying Patient',
      save_consultation: 'Save Consultation',
      no_history_available: 'No history available.',
      printable_bill: 'Printable Bill',
      enter_doctor_name: 'Enter doctor\'s name',
      specific_concerns: 'Any specific concerns or symptoms...',
      height_example: 'e.g., 175',
      weight_example: 'e.g., 70.5',
      temperature_example: 'e.g., 37.0',
      heart_rate_example: 'e.g., 72',
      blood_sugar_example: 'e.g., 95',
      blood_pressure_example: 'e.g., 120/80',
      enter_vital_notes: 'Enter vital notes...',
      enter_reason: 'Enter reason for consultation',
      enter_diagnosis: 'Enter diagnosis',
      enter_clinical_exam: 'Enter clinical examination findings',
      enter_notes: 'Enter additional notes',
      drugs_dosage: 'Drugs, dosage, duration',
      file_number_example: 'Enter patient file number (e.g., P-2024-001)',
      cin_passport_example: 'Enter CIN or Passport number',
      full_name_example: 'Enter patient\'s full name',
      email_example: 'patient@example.com',
      phone_example: '+216 20 123 456',
      address_example: 'Street address, City, State',
      medical_history_example: 'Any relevant medical history, allergies, or notes...',
      search_patients: 'Search patients by name, CIN/Passport, file number, email, phone, or date of birth...',
      consultation_fee_example: 'e.g., Consultation fee',
      no_medical_files: 'No medical files found for this patient.',
      files_selected: 'file(s) selected for upload.',
      select_patient_appointment: 'Please select a patient for the appointment.',
      fill_required_fields: 'Please fill in all required fields.',
      valid_email: 'Please enter a valid email address.',
      future_date: 'Please select a future date for your appointment.',
      appointment_not_found: 'Appointment not found. Please refresh the page and try again.',
      fill_required_patient_fields: 'Please fill in all required fields (File Number, CIN/Passport, Name, Phone, Date of Birth).',
      email_exists: 'A patient with this email address already exists.',
      file_number_exists: 'A patient with this file number already exists.',
      cin_passport_exists: 'A patient with this CIN/Passport number already exists.',
      no_patient_selected: 'No patient selected for editing.',
      patient_not_found_storage: 'Patient not found in storage.',
      patient_not_found: 'Patient not found.',
      delete_patient_confirm: 'Are you sure you want to delete',
      patient_deleted: 'Patient deleted successfully.',
      at_least_one_item: 'At least one item is required for the bill.',
      popup_blocked: 'Popup blocked! Please allow popups for this site and try again, or use the alternative method below.',
      print_error: 'Error opening print window. Using alternative method.',
      select_patient_bill: 'Please select a patient for the bill.',
      bill_created_success: '✅ Bill created successfully!\n\nPatient: {0}\nTotal: {1} TND\n\nWould you like to print the bill now?',
      bill_id: 'Bill ID:',
      patient: 'Patient:',
      total: 'Total:',
      print_bill_now: 'Would you like to print the bill now?',
      error_creating_bill: 'Error creating bill: {0}',
      consultations_doctors_only: 'Consultations are available to doctors only.',
      fill_required_consultation: 'Please fill required fields.',
      consultation_saved: 'Consultation saved.',
      logout_confirm: 'Are you sure you want to logout?',
      logout: 'Logout',
      cancelled: 'Cancelled',
      doctor_dashboard: 'Doctor Dashboard',
      today_appointments: 'Today\'s Appointments',
      today_consultations: 'Today\'s Consultations',
      no_appointments_today: 'No appointments scheduled for today.',
      no_consultations_today: 'No consultations conducted today.',
      consult: 'Consult',
      reject: 'Reject',
      view_details: 'View Details',
      consultation_details: 'Consultation Details',
      close: 'Close',
      laboratory_assessment: 'Laboratory Assessment Examination',
      add_lab_assessment: 'Add Lab Assessment',
      lab_assessment_desc: 'Upload laboratory assessment documents and add notes about the examination results.',
      patient: 'Patient',
      consultation_date: 'Consultation Date',
      upload_documents: 'Upload Laboratory Documents',
      upload_documents_hint: 'You can upload multiple files (PDF, images, etc.)',
      lab_results: 'Lab Results',
      lab_notes: 'Laboratory Assessment Notes',
      lab_notes_hint: 'Add notes, observations, or interpretations of the laboratory results',
      enter_lab_results: 'Enter lab results...',
      enter_lab_notes: 'Enter lab notes and observations...',
      previous_assessments: 'Previous Assessments',
      save_assessment: 'Save Assessment',
      assessment_saved: 'Laboratory assessment saved successfully!',
      radiology_result: 'Radiology Result',
      diagnostics: 'Diagnostics',
      enter_radiology_result: 'Enter radiology result...',
      enter_diagnostics: 'Enter diagnostics...',
      medical_certificate: 'Medical Certificate',
      certificate_type: 'Certificate Type',
      rest_period: 'Rest Period (Days)',
      start_date: 'Start Date',
      end_date: 'End Date',
      diagnosis_condition: 'Diagnosis / Medical Condition',
      recommendations: 'Recommendations',
      additional_notes: 'Additional Notes',
      certificate_info: 'Certificate Information',
      certificate_info_text: 'After saving, you can view and print the certificate from the consultation details.',
      print_certificate: 'Print Certificate',
      print_prescription: 'Print Prescription',
      save_certificate: 'Save Certificate',
      certificate_saved: 'Medical certificate saved successfully!',
      date: 'Date',
      // Alerts & status messages
      bill_not_selected: 'Please select a bill first.',
      bill_not_found: 'Bill not found.',
      bill_marked_paid: 'Bill marked as paid.',
      error_marking_bill_paid: 'Error marking bill as paid.',
      error_updating_payment_status: 'Error updating payment status.',
      payment_status_updated: 'Payment status updated successfully.',
      prescription_cleared: 'Prescription cleared.',
      no_medicines_found: 'No medicines found.',
      expense_deleted: 'Expense deleted successfully.',
      expense_updated: 'Expense updated successfully.',
      expense_added: 'Expense added successfully.',
      medicine_deleted: 'Medicine deleted successfully!',
      report_exported_successfully: 'Report exported successfully!',
      appointment_update_failed: 'Failed to update appointment status. Please try again.',
      file_too_large: 'File is too large. Maximum size is 10MB.',
      file_upload_error: 'Error reading file.',
      'Consultation not found.': 'Consultation not found.',
      'Patient not found in system. Please add patient first.': 'Patient not found in system. Please add patient first.',
      'No consultations found for this patient.': 'No consultations found for this patient.',
      'Last consultation not found.': 'Last consultation not found.',
      'Error updating last consultation.': 'Error updating last consultation.',
      'Reason documented successfully': 'Reason documented successfully.',
      'Diagnosis documented successfully': 'Diagnosis documented successfully.',
      'Clinical examination documented successfully': 'Clinical examination documented successfully.',
      'Please select a patient first.': 'Please select a patient first.',
      'Popup blocked. Please allow popups to print.': 'Popup blocked. Please allow popups to print.'
    },
    fr: {
      dashboard: 'Tableau de bord',
      add_appointment: 'Ajouter un rendez-vous',
      patients: 'Patients',
      billing: 'Facturation',
      payment_tab: 'Paiement',
      reports: 'Rapports',
      consultation: 'Consultation',
      settings: 'Paramètres',
      language_settings: 'Paramètres de langue',
      select_language: 'Sélectionner la langue:',
      close: 'Fermer',
      manage_language: 'Changer la langue de l\'application',
      bill_descriptions: 'Descriptions de facture',
      manage_bill_descriptions: 'Gérer les articles de facturation',
      add_new_description: 'Ajouter un nouveau service',
      service_name: 'Nom du service',
      default_price: 'Prix par défaut (TND)',
      add_service: 'Ajouter un service',
      existing_services: 'Services existants',
      search_services: 'Rechercher des services...',
      edit_service: 'Modifier le service',
      save_changes: 'Enregistrer les modifications',
      delete_service: 'Supprimer le service',
      confirm_delete_service: 'Êtes-vous sûr de vouloir supprimer ce service?',
      service_added: 'Service ajouté avec succès!',
      service_updated: 'Service mis à jour avec succès!',
      service_deleted: 'Service supprimé avec succès!',
      cabinet_settings: 'Paramètres du cabinet',
      manage_cabinet_info: 'Gérer le nom, logo et horaires du cabinet',
      cabinet_information: 'Informations du cabinet',
      cabinet_name: 'Nom du cabinet',
      cabinet_address: 'Adresse du cabinet',
      cabinet_phone: 'Téléphone du cabinet',
      cabinet_logo: 'Logo du cabinet',
      upload_logo: 'Télécharger le logo',
      remove_logo: 'Supprimer le logo',
      logo_recommendation: 'Recommandé: Image carrée, max 2 Mo',
      cabinet_timetable: 'Heures de travail / Horaire',
      monday: 'Lundi',
      tuesday: 'Mardi',
      wednesday: 'Mercredi',
      thursday: 'Jeudi',
      friday: 'Vendredi',
      saturday: 'Samedi',
      sunday: 'Dimanche',
      save_settings: 'Enregistrer les paramètres',
      settings_saved: 'Paramètres enregistrés avec succès!',
      logo_too_large: 'L\'image est trop grande. Taille maximale: 2 Mo.',
      invalid_image: 'Fichier image invalide. Veuillez télécharger une image valide.',
      user_management: 'Gestion des utilisateurs',
      manage_users_access: 'Gérer les utilisateurs et leurs accès',
      add_new_user: 'Ajouter un nouvel utilisateur',
      existing_users: 'Utilisateurs existants',
      total_users: 'Total utilisateurs',
      search_users: 'Rechercher des utilisateurs par nom, email ou nom d\'utilisateur...',
      user_full_name: 'Nom complet',
      user_email: 'Email',
      username: 'Nom d\'utilisateur',
      password: 'Mot de passe',
      new_password: 'Nouveau mot de passe',
      password_hint: 'Laisser vide pour conserver le mot de passe actuel',
      user_role: 'Rôle',
      user_status: 'Statut',
      actions: 'Actions',
      add_user: 'Ajouter un utilisateur',
      edit_user: 'Modifier l\'utilisateur',
      delete_user: 'Supprimer l\'utilisateur',
      confirm_delete_user: 'Êtes-vous sûr de vouloir supprimer cet utilisateur?',
      user_added: 'Utilisateur ajouté avec succès!',
      user_updated: 'Utilisateur mis à jour avec succès!',
      user_deleted: 'Utilisateur supprimé avec succès!',
      username_exists: 'Le nom d\'utilisateur existe déjà!',
      email_exists: 'L\'email existe déjà!',
      user_permissions: 'Permissions utilisateur',
      patients_module: 'Module Patients',
      perm_view_patients: 'Voir les patients',
      perm_add_patients: 'Ajouter/Modifier les patients',
      perm_delete_patients: 'Supprimer les patients',
      appointments_module: 'Module Rendez-vous',
      perm_view_appointments: 'Voir les rendez-vous',
      perm_add_appointments: 'Ajouter/Modifier les rendez-vous',
      perm_delete_appointments: 'Supprimer les rendez-vous',
      billing_module: 'Module Facturation',
      perm_view_bills: 'Voir les factures',
      perm_create_bills: 'Créer des factures',
      perm_manage_bills: 'Gérer les factures',
      consultations_module: 'Module Consultations',
      perm_view_consultations: 'Voir les consultations',
      perm_add_consultations: 'Ajouter/Modifier les consultations',
      perm_delete_consultations: 'Supprimer les consultations',
      reports_module: 'Module Rapports',
      perm_view_reports: 'Voir les rapports',
      perm_export_reports: 'Exporter les rapports',
      settings_module: 'Module Paramètres',
      perm_access_settings: 'Accéder aux paramètres',
      perm_manage_users: 'Gérer les utilisateurs',
      expenses_module: 'Module Dépenses',
      perm_view_expenses: 'Voir les dépenses',
      perm_manage_expenses: 'Gérer les dépenses',
      secretary_agenda: 'Agenda de secrétaire',
      manage_appointments: 'Gérer les rendez-vous quotidiens et les horaires',
      cancel: 'Annuler',
      save: 'Enregistrer',
      edit: 'Modifier',
      delete: 'Supprimer',
      add: 'Ajouter',
      create: 'Créer',
      secretary: 'Secrétaire',
      patient_file_number: 'Numéro de dossier patient',
      file_number: 'Numéro de dossier',
      cin_passport: 'CIN ou Passeport *',
      add_new_appointment: 'Ajouter un nouveau rendez-vous',
      patient_management: 'Gestion des patients',
      edit_patient: 'Modifier le patient',
      create_patient_bill: 'Créer une facture patient',
      add_new_patient: 'Ajouter un nouveau patient',
      view_all_patients: 'Voir tous les patients',
      add_patient: 'Ajouter un patient',
      update_patient: 'Mettre à jour le patient',
      create_bill: 'Créer une facture',
      test_print: 'Test d\'impression',
      select_patient: 'Sélectionner un patient *',
      full_name: 'Nom complet *',
      email_address: 'Adresse e-mail',
      phone_number: 'Numéro de téléphone *',
      appointment_date: 'Date du rendez-vous',
      appointment_time: 'Heure du rendez-vous',
      appointment_type: 'Type de rendez-vous',
      doctor_name: 'Nom du médecin *',
      additional_notes: 'Notes supplémentaires',
      date_of_birth: 'Date de naissance *',
      gender: 'Genre',
      address: 'Adresse',
      medical_history: 'Historique médical / Notes',
      medical_files: 'Dossiers médicaux',
      bill_date: 'Date de facturation',
      due_date: 'Date d\'échéance',
      bill_items: 'Articles de facturation',
      description: 'Description',
      quantity: 'Quantité',
      price: 'Prix (TND)',
      notes: 'Notes',
      remove_item: 'Supprimer l\'élément',
      add_item: 'Ajouter un élément',
      new_consultation: 'Nouvelle Consultation',
      patient_info: 'Informations Patient',
      name: 'Nom',
      phone: 'Téléphone',
      age_gender: 'Âge/Genre',
      height_cm: 'Taille (cm)',
      weight_kg: 'Poids (kg)',
      bmi: 'IMC (BMI)',
      temperature_c: 'Température (°C)',
      heart_rate_bpm: 'Fréquence Cardiaque (bpm)',
      blood_sugar_mgdl: 'Glycémie (mg/dL)',
      blood_pressure_mmhg: 'Pression Artérielle (mmHg)',
      vital_notes: 'Notes Vitales',
      reason: 'Motif de la visite',
      diagnosis: 'Diagnostic',
      clinical_examination: 'Examen Clinique',
      clinical_notes: 'Notes clinique',
      prescription: 'Prescription',
      consultation_act: 'Acte de consultation',
      consultation_amount: 'Montant de la consultation',
      payment_status: 'Statut de paiement',
      paid_status: 'Payé',
      partially_paid_status: 'Partiellement payé',
      unpaid_status: 'Non payé',
      unpaid_patients: 'Patients impayés',
      in_progress_payments: 'Patients en cours de paiement',
      loading_unpaid_patients: 'Chargement des patients impayés...',
      loading_in_progress_payments: 'Chargement des patients en cours de paiement...',
      partial_payment_progress: 'Avancement du paiement',
      add_partial_payment: 'Ajouter un paiement',
      enter_partial_payment_amount: 'Saisissez le premier montant payé (TND) :',
      enter_additional_partial_payment_amount: 'Saisissez un montant de paiement supplémentaire (TND) :',
      invalid_partial_payment_amount: 'Veuillez saisir un montant valide supérieur à 0.',
      partial_payment_exceeds_total: 'Le paiement partiel ne peut pas dépasser le montant total de la consultation.',
      paying_patient: 'Patient payant',
      non_paying_patient: 'Patient non payant',
      save_consultation: 'Enregistrer la consultation',
      no_history_available: 'Aucun historique disponible.',
      printable_bill: 'Facture Imprimable',
      enter_doctor_name: 'Entrez le nom du médecin',
      specific_concerns: 'Toute préoccupation ou symptôme spécifique...',
      height_example: 'ex., 175',
      weight_example: 'ex., 70.5',
      temperature_example: 'ex., 37.0',
      heart_rate_example: 'ex., 72',
      blood_sugar_example: 'ex., 95',
      blood_pressure_example: 'ex., 120/80',
      enter_vital_notes: 'Entrez les notes vitales...',
      enter_reason: 'Entrez le motif de la consultation',
      enter_diagnosis: 'Entrez le diagnostic',
      enter_clinical_exam: 'Entrez les résultats de l\'examen clinique',
      enter_notes: 'Entrez des notes supplémentaires',
      drugs_dosage: 'Médicaments, posologie, durée',
      file_number_example: 'Entrez le numéro de dossier patient (ex., P-2024-001)',
      cin_passport_example: 'Entrez le CIN ou numéro de passeport',
      full_name_example: 'Entrez le nom complet du patient',
      email_example: 'patient@exemple.com',
      phone_example: '+216 20 123 456',
      address_example: 'Adresse, Ville, État',
      medical_history_example: 'Tout historique médical pertinent, allergies ou notes...',
      search_patients: 'Rechercher des patients par nom, CIN/Passeport, numéro de dossier, email, téléphone ou date de naissance...',
      consultation_fee_example: 'ex., Frais de consultation',
      no_medical_files: 'Aucun fichier médical trouvé pour ce patient.',
      files_selected: 'fichier(s) sélectionné(s) pour téléchargement.',
      select_patient_appointment: 'Veuillez sélectionner un patient pour le rendez-vous.',
      fill_required_fields: 'Veuillez remplir tous les champs obligatoires.',
      valid_email: 'Veuillez entrer une adresse email valide.',
      future_date: 'Veuillez sélectionner une date future pour votre rendez-vous.',
      appointment_not_found: 'Rendez-vous non trouvé. Veuillez actualiser la page et réessayer.',
      fill_required_patient_fields: 'Veuillez remplir tous les champs obligatoires (Numéro de dossier, CIN/Passeport, Nom, Téléphone, Date de naissance).',
      email_exists: 'Un patient avec cette adresse email existe déjà.',
      file_number_exists: 'Un patient avec ce numéro de dossier existe déjà.',
      cin_passport_exists: 'Un patient avec ce CIN/numéro de passeport existe déjà.',
      no_patient_selected: 'Aucun patient sélectionné pour modification.',
      patient_not_found_storage: 'Patient non trouvé dans le stockage.',
      patient_not_found: 'Patient non trouvé.',
      delete_patient_confirm: 'Êtes-vous sûr de vouloir supprimer',
      patient_deleted: 'Patient supprimé avec succès.',
      at_least_one_item: 'Au moins un élément est requis pour la facture.',
      popup_blocked: 'Popup bloqué! Veuillez autoriser les popups pour ce site et réessayer, ou utilisez la méthode alternative ci-dessous.',
      print_error: 'Erreur lors de l\'ouverture de la fenêtre d\'impression. Utilisation de la méthode alternative.',
      select_patient_bill: 'Veuillez sélectionner un patient pour la facture.',
      bill_created_success: '✅ Facture créée avec succès!\n\nPatient: {0}\nTotal: {1} TND\n\nVoulez-vous imprimer la facture maintenant?',
      bill_id: 'ID de facture:',
      patient: 'Patient:',
      total: 'Total:',
      print_bill_now: 'Voulez-vous imprimer la facture maintenant?',
      error_creating_bill: 'Erreur lors de la création de la facture: {0}',
      consultations_doctors_only: 'Les consultations sont disponibles uniquement pour les médecins.',
      fill_required_consultation: 'Veuillez remplir les champs obligatoires.',
      consultation_saved: 'Consultation enregistrée.',
      logout_confirm: 'Êtes-vous sûr de vouloir vous déconnecter?',
      logout: 'Déconnexion',
      cancelled: 'Annulé',
      doctor_dashboard: 'Tableau de bord médecin',
      today_appointments: 'Rendez-vous d\'aujourd\'hui',
      today_consultations: 'Consultations d\'aujourd\'hui',
      no_appointments_today: 'Aucun rendez-vous programmé pour aujourd\'hui.',
      no_consultations_today: 'Aucune consultation effectuée aujourd\'hui.',
      consult: 'Consulter',
      reject: 'Rejeter',
      view_details: 'Voir les détails',
      consultation_details: 'Détails de la consultation',
      close: 'Fermer',
      laboratory_assessment: 'Examen d\'évaluation de laboratoire',
      add_lab_assessment: 'Ajouter une évaluation de laboratoire',
      lab_assessment_desc: 'Téléchargez les documents d\'évaluation de laboratoire et ajoutez des notes sur les résultats de l\'examen.',
      patient: 'Patient',
      consultation_date: 'Date de consultation',
      upload_documents: 'Télécharger les documents de laboratoire',
      upload_documents_hint: 'Vous pouvez télécharger plusieurs fichiers (PDF, images, etc.)',
      lab_results: 'Résultats des analyses laboratoire',
      lab_notes: 'Demande des analyses laboratoire',
      lab_notes_hint: 'Ajoutez la demande des analyses laboratoire, observations ou interprétations des résultats de laboratoire',
      enter_lab_results: 'Entrez les résultats de laboratoire...',
      enter_lab_notes: 'Entrez les notes et observations de laboratoire...',
      previous_assessments: 'Évaluations précédentes',
      save_assessment: 'Enregistrer l\'évaluation',
      assessment_saved: 'Évaluation de laboratoire enregistrée avec succès!',
      radiology_result: 'Résultats des examens radiologie',
      diagnostics: 'Demande des examens radiologie',
      enter_radiology_result: 'Entrez les résultats des examens radiologie...',
      enter_diagnostics: 'Entrez la demande des examens radiologie...',
      no_files_selected: 'Aucun fichier sélectionné',
      file_uploaded: 'Fichier téléchargé',
      remove_file: 'Supprimer le fichier',
      medical_certificate: 'Certificat médical',
      certificate_type: 'Type de certificat',
      rest_period: 'Période de repos (jours)',
      start_date: 'Date de début',
      end_date: 'Date de fin',
      diagnosis_condition: 'Diagnostic / Condition médicale',
      recommendations: 'Recommandations',
      additional_notes: 'Notes supplémentaires',
      certificate_info: 'Informations sur le certificat',
      certificate_info_text: 'Après l\'enregistrement, vous pouvez consulter et imprimer le certificat depuis les détails de la consultation.',
      print_certificate: 'Imprimer le certificat',
      print_prescription: 'Imprimer l\'ordonnance',
      save_certificate: 'Enregistrer le certificat',
      certificate_saved: 'Certificat médical enregistré avec succès!',
      date: 'Date',
      // Alerts & status messages
      bill_not_selected: 'Veuillez sélectionner une facture d\'abord.',
      bill_not_found: 'Facture introuvable.',
      bill_marked_paid: 'Facture marquée comme payée.',
      error_marking_bill_paid: 'Erreur lors du marquage de la facture comme payée.',
      error_updating_payment_status: 'Erreur lors de la mise à jour du statut de paiement.',
      payment_status_updated: 'Statut de paiement mis à jour avec succès.',
      prescription_cleared: 'Prescription effacée.',
      no_medicines_found: 'Aucun médicament trouvé.',
      expense_deleted: 'Dépense supprimée avec succès.',
      expense_updated: 'Dépense mise à jour avec succès.',
      expense_added: 'Dépense ajoutée avec succès.',
      medicine_deleted: 'Médicament supprimé avec succès!',
      report_exported_successfully: 'Rapport exporté avec succès !',
      appointment_update_failed: 'Échec de la mise à jour du statut du rendez-vous. Veuillez réessayer.',
      file_too_large: 'Le fichier est trop volumineux. La taille maximale est 10 Mo.',
      file_upload_error: 'Erreur lors de la lecture du fichier.',
      'Consultation not found.': 'Consultation non trouvée.',
      'Patient not found in system. Please add patient first.': 'Patient introuvable dans le système. Veuillez d\'abord ajouter le patient.',
      'No consultations found for this patient.': 'Aucune consultation trouvée pour ce patient.',
      'Last consultation not found.': 'Dernière consultation introuvable.',
      'Error updating last consultation.': 'Erreur lors de la mise à jour de la dernière consultation.',
      'Reason documented successfully': 'Motif enregistré avec succès.',
      'Diagnosis documented successfully': 'Diagnostic enregistré avec succès.',
      'Clinical examination documented successfully': 'Examen clinique enregistré avec succès.',
      'Please select a patient first.': 'Veuillez d\'abord sélectionner un patient.',
      'Popup blocked. Please allow popups to print.': 'Popup bloquée. Veuillez autoriser les popups pour imprimer.'
    }
  };

  // Expose globally
  window.translations = translations;

  // t helper: prefer I18n if available, else local translations
  window.t = function(key, fallback){
    try {
      if (window.I18n && typeof window.I18n.t === 'function') {
        var v = window.I18n.t(key);
        if (typeof v === 'string' && v && v !== key) return v;
      }
    } catch(e){}
    var lang = window.currentLanguage || getLang();
    return (translations[lang] && translations[lang][key]) || fallback || key;
  };

  // Update translations across the document (fallback when I18n is absent)
  window.updateModalTranslations = function(){
    const lang = (window.I18n && I18n.getLanguage ? I18n.getLanguage() : null) || window.currentLanguage || getLang();

    // Special-case: consultation modal menu buttons with inner span
    const consultationModal = document.getElementById('consultationModal');
    if (consultationModal && consultationModal.classList.contains('active')) {
      const menuButtons = consultationModal.querySelectorAll('.consult-menu-btn');
      menuButtons.forEach(btn => {
        const key = btn.getAttribute('data-translate');
        if (key) {
          const val = (window.I18n && typeof I18n.t === 'function') ? I18n.t(key) : (translations[lang] && translations[lang][key]);
          if (val) {
            const span = btn.querySelector('span');
            if (span) span.textContent = val;
            else btn.textContent = val;
          }
        }
      });
    }

    // Generic text content translation for the whole document
    const allTextEls = document.querySelectorAll('[data-translate]');
    allTextEls.forEach(element => {
      const key = element.getAttribute('data-translate');
      if (!key) return;
      let val = (window.I18n && typeof I18n.t === 'function') ? I18n.t(key) : (translations[lang] && translations[lang][key]);
      if (val === key) val = (translations[lang] && translations[lang][key]);
      if (val && element.querySelector('span') === null) {
        element.textContent = val;
      }
    });

    // Placeholders
    const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
    placeholderElements.forEach(element => {
      const key = element.getAttribute('data-translate-placeholder');
      if (!key) return;
      let val = (window.I18n && typeof I18n.t === 'function') ? I18n.t(key) : (translations[lang] && translations[lang][key]);
      if (val === key) val = (translations[lang] && translations[lang][key]);
      if (val) element.placeholder = val;
    });
  };

  // Keep global currentLanguage synced when I18n switches
  setTimeout(function(){
    if (window.I18n && typeof window.I18n.setLanguage === 'function'){
      const orig = window.I18n.setLanguage.bind(window.I18n);
      window.I18n.setLanguage = async function(lang){
        const r = await orig(lang);
        setLang(lang);
        try { window.updateModalTranslations && window.updateModalTranslations(); } catch(e){}
        return r;
      };
    }
  }, 0);

  // Translate immediately on initial load
  if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', function(){
      try {
        if (window.I18n && typeof window.I18n.walkAndTranslate === 'function') {
          if (typeof I18n.getLanguage === 'function') {
            var lang = I18n.getLanguage();
            if (lang) setLang(lang);
          }
          window.I18n.walkAndTranslate();
        }
        if (typeof window.updateModalTranslations === 'function') {
          window.updateModalTranslations();
        }
      } catch(e) { /* noop */ }
    });
  }

})();